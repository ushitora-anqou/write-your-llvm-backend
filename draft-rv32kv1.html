<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16.dev">
<meta name="author" content="艮鮟鱇">
<title>[下書き] LLVMバックエンド開発文書 for RV32Kv1</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>[下書き] LLVMバックエンド開発文書 for RV32Kv1</h1>
<div class="details">
<span id="author" class="author">艮鮟鱇</span><br>
<span id="email" class="email"><a href="mailto:ushitora@anqou.net">ushitora@anqou.net</a></span><br>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_これはなに">これはなに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>2019年にRV32Kv1という自作ISA用のLLVMバックエンドを作ったときの自分とメンバ用のメモ。
メモなので当然読みにくい。これをブラッシュアップしてまともな文章にする予定だったが、
その作業が遅れているので、一旦メモのまま公開する。内容について質問したい場合は
Twitter <a href="https://twitter.com/ushitora_anqou">@ushitora_anqou</a>までリプライなどを貰えれば反応するかもしれない。</p>
</div>
<div class="paragraph">
<p>ソースコードは未公開。</p>
</div>
<div class="paragraph">
<p>ブラッシュアップは<a href="https://github.com/ushitora-anqou/write-your-llvm-backend">GitHub</a>にて行っている。</p>
</div>
<div class="paragraph">
<p>このLLVMバックエンドの開発は、もともと2019年度未踏事業において
<a href="https://github.com/virtualsecureplatform/kvsp">Virtual Secure Platform</a>を開発するために行われた。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_アセンブラ簡単使い方">アセンブラ簡単使い方</h2>
<div class="sectionbody">
<div class="paragraph">
<p>とりあえずビルドする。ビルドには</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cmake</code></p>
</li>
<li>
<p><code>ninja</code></p>
</li>
<li>
<p><code>clang</code></p>
</li>
<li>
<p><code>clang++</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>が必要。</p>
</div>
<div class="paragraph">
<p>これらを入れた後 <code>cmake</code> を次のように走らせる。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cmake -G Ninja \
    -DLLVM_ENABLE_PROJECTS=clang \
    -DCMAKE_BUILD_TYPE="Debug" \
    -DBUILD_SHARED_LIBS=True \
    -DLLVM_USE_SPLIT_DWARF=True \
    -DLLVM_OPTIMIZED_TABLEGEN=True \
    -DLLVM_BUILD_TESTS=True \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DLLVM_USE_LINKER=lld \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    -DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD="RISCV;RV32K" \
    ../llvm
$ cmake --build .</pre>
</div>
</div>
<div class="paragraph">
<p>その後アセンブラを起動する。アセンブラは <code>build/bin/llvm-mc</code> である。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat foo.s
li x9, 3
mv x11, x1
sub x9, x10
add x8, x1
nop

$ bin/llvm-mc -arch=rv32k -filetype=obj foo.s | od -tx1z -Ax -v
000000 7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00  &gt;.ELF............&lt;
000010 01 00 f5 00 01 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000020 68 00 00 00 00 00 00 00 34 00 00 00 00 00 28 00  &gt;h.......4.....(.&lt;
000030 04 00 01 00 8d 44 86 85 89 8c 06 94 01 00 00 00  &gt;.....D..........&lt;
000040 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000050 00 2e 74 65 78 74 00 2e 73 74 72 74 61 62 00 2e  &gt;..text..strtab..&lt;
000060 73 79 6d 74 61 62 00 00 00 00 00 00 00 00 00 00  &gt;symtab..........&lt;
000070 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000080 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000090 07 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
0000a0 50 00 00 00 17 00 00 00 00 00 00 00 00 00 00 00  &gt;P...............&lt;
0000b0 01 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00  &gt;................&lt;
0000c0 06 00 00 00 00 00 00 00 34 00 00 00 0a 00 00 00  &gt;........4.......&lt;
0000d0 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00  &gt;................&lt;
0000e0 0f 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
0000f0 40 00 00 00 10 00 00 00 01 00 00 00 01 00 00 00  &gt;@...............&lt;
000100 04 00 00 00 10 00 00 00                          &gt;........&lt;
000108</pre>
</div>
</div>
<div class="paragraph">
<p>0x34から0x3dにある <code>8d 44 86 85 89 8c 06 94 01 00</code> が出力である。</p>
</div>
<div class="paragraph">
<p>このような出力の他に <code>-show-encoding</code> を用いる方法もある。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-mc -arch=rv32k -show-encoding foo.s
	.text
	li	x9, 3                   # encoding: [0x8d,0x44]
	mv	x11, x1                 # encoding: [0x86,0x85]
	sub	x9, x10                 # encoding: [0x89,0x8c]
	add	x8, x1                  # encoding: [0x06,0x94]
	nop	                        # encoding: [0x01,0x00]</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_概要">概要</h2>
<div class="sectionbody">
<div class="paragraph">
<p>これを読めば自作アーキテクチャ（RV32Kv1）の機械語を出力するLLVMバックエンドを作成することができる。</p>
</div>
<div class="paragraph">
<p>この文書はAsciiDocを用いて記述されている。記述方法については<a href="#asciidoctor_user-manual">[4]</a>を参照のこと。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参考にすべき資料">参考にすべき資料</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Writing an LLVM Backend<a href="#llvm-writing_backend">[18]</a></p>
</li>
<li>
<p>『きつねさんでもわかるLLVM〜コンパイラを自作するためのガイドブック〜』<a href="#fox-llvm">[7]</a></p>
</li>
<li>
<p>RISC-V support for LLVM projects<a href="#github_riscv-llvm">[10]</a>
LLVMにRISC-Vサポートを追加するパッチ群。バックエンドを開発するためのチュートリアルも兼ねているらしく <code>docs/</code> 及びそれと対応したpatchが参考になる。
またこれについて、開発者が2018 LLVM Developers' Meetingで登壇したときの動画は<a href="#youtube_llvm-backend-development-by-example">[11]</a>より閲覧できる。
スライドは<a href="#speakerdeck-llvm_backend_development">[30]</a>より閲覧できる。</p>
</li>
<li>
<p>TableGenのLLVMのドキュメント<a href="#llvm-tablegen">[21]</a></p>
</li>
<li>
<p>The LLVM Target-Independent Code Generator<a href="#llvm-code_generator">[31]</a></p>
</li>
<li>
<p>Create an LLVM Backend for the Cpu0 Architecture<a href="#cpu0">[35]</a></p>
<div class="ulist">
<ul>
<li>
<p>これをもとにLLVMバックエンドを開発しているブログ<a href="#fpga_develop_diary">[44]</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>ELVMバックエンド<a href="#elvm-llvm_backend">[36]</a></p>
<div class="ulist">
<ul>
<li>
<p>限られた命令でLLVM IRの機能を達成する例として貴重。</p>
<div class="ulist">
<ul>
<li>
<p>でも意外とISAはリッチだったりする。</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hamajiさんのスライドも参考になる<a href="#elvm-slide">[37]</a>。</p>
</li>
</ul>
</div>
</li>
<li>
<p>2018年度東大CPU実験で開発されたLLVM Backend<a href="#todai_llvm_backend">[40]</a></p>
<div class="ulist">
<ul>
<li>
<p>これについて書かれたAdCのエントリもある<a href="#todai_llvm_backend-article">[41]</a>。</p>
</li>
</ul>
</div>
</li>
<li>
<p>LLVM Language Reference Manual<a href="#llvm-langref">[43]</a></p>
<div class="ulist">
<ul>
<li>
<p>LLVM IRについての言語リファレンス。意外と実装すべき命令が少ないことが分かる。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rv32kv1アーキテクチャ仕様">RV32Kv1アーキテクチャ仕様</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RV32Kv1はRISC-V<a href="#riscv">[5]</a>のISA<a href="#riscv_specifications">[6]</a>であるRV32Cをベースとして設定する。
RV32Cからそのまま借用する命令は下記のとおりである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LWSP</p>
</li>
<li>
<p>SWSP</p>
</li>
<li>
<p>LW</p>
</li>
<li>
<p>SW</p>
</li>
<li>
<p>J</p>
</li>
<li>
<p>JAL</p>
</li>
<li>
<p>JR</p>
</li>
<li>
<p>JALR</p>
</li>
<li>
<p>BEQZ</p>
</li>
<li>
<p>BNEZ</p>
</li>
<li>
<p>LI</p>
</li>
<li>
<p>MV</p>
</li>
<li>
<p>ADD</p>
</li>
<li>
<p>SUB</p>
</li>
<li>
<p>NOP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>RV32Cに無く、新設する命令は下記のとおりである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SLT</p>
<div class="ulist">
<ul>
<li>
<p>次に示すReservedのうち上の方を使う。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="img/rv32c_reserved_insts.png" alt="rv32c reserved insts">
</div>
</div>
<div class="paragraph">
<p>エンディアンにはリトルエンディアンを採用する。</p>
</div>
<div class="paragraph">
<p>レジスタは次の通り。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>x1/ra : return address register / ABI link register</p>
</li>
<li>
<p>x2/sp : ABI stack pointer</p>
</li>
<li>
<p>x8-x15 : general purpose register</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>分岐時のPC更新は <code>PC &#8592; PC + d</code> とする（ <code>PC &#8592; PC + 1 + d</code> <strong>でない</strong>）。</p>
</div>
<div class="paragraph">
<p>関数呼び出し規約は次の通り。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>x8-x15 : 引数0番目〜7番目</p>
</li>
<li>
<p>x8 : 戻り値</p>
</li>
<li>
<p>sp : callee-saved</p>
</li>
<li>
<p>x15 : frame register</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_マイルストーン">マイルストーン</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>MachineCodeからMCLayerに変換するアセンブラ</p>
<div class="ulist">
<ul>
<li>
<p>RV32Kアセンブリを受け取ってELFバイナリを出力する。</p>
</li>
<li>
<p>ELFバイナリである必要は微塵もないが、既存のLLVMコードベースを利用するためにはこれが必要。</p>
<div class="ulist">
<ul>
<li>
<p>最終的には自作バイナリに出力するようにしたい。</p>
</li>
</ul>
</div>
</li>
<li>
<p>実際に食わせるためにはELFバイナリを適当にstripする変換器を必要するかもしれない。</p>
</li>
<li>
<p>というか同一ファイル内でシンボル解決を行うリンカもどきが必要になる。あと <code>main</code> もとい <code>_start</code> がバイナリの一番最初にないといけないなどありそう。</p>
</li>
<li>
<p>自作C標準ライブラリも必要かも。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_llvmのソースコードを用意する">LLVMのソースコードを用意する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LLVMのソースコードを取得する。今回の開発ではv8.0.0をベースとする。
Git上でrv32kブランチを作り、その上で開発する。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git clone https://github.com/llvm/llvm-project.git
$ cd llvm-project
$ git checkout llvmorg-8.0.0
$ git checkout -b rv32k</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_llvmclangをビルドする">LLVM・Clangをビルドする</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#github_riscv-llvm_docs_01">[1]</a>, <a href="#llvm_getting-started">[2]</a>, <a href="#clang_gettings-started">[3]</a>を参考にしてLLVMとClangをNinjaを用いてビルドする。
以降の開発において参考にするため、x86とRISC VをLLVM・Clangの出力可能ターゲットとして指定する。</p>
</div>
<div class="paragraph">
<p>なお、CPUがIntel Core i5 7200U、メモリが8GBのLet&#8217;s note上でのビルドには1時間半程度要した。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mkdir build
$ cd build
$ cmake -G Ninja \
    -DLLVM_ENABLE_PROJECTS=clang \
    -DCMAKE_BUILD_TYPE="Debug" \
    -DBUILD_SHARED_LIBS=True \
    -DLLVM_USE_SPLIT_DWARF=True \
    -DLLVM_OPTIMIZED_TABLEGEN=True \
    -DLLVM_BUILD_TESTS=True \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DLLVM_USE_LINKER=lld \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    -DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD="RISCV" \
    ../llvm
$ cmake --build . # OR ninja</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_llvmclangを使う">LLVM・Clangを使う</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RV32バックエンドを使う例をいくつか掲げる<a href="#msyksphinz_try-riscv64-llvm-backend">[12]</a>。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/clang -target riscv32-unknown-linux-gnu -S -o main.s main.c    # main.cをRV32のアセンブリにコンパイル
$ bin/clang -target riscv32-unknown-linux-gnu -emit-llvm -o main.bc -c main.c   # main.cをRV32用のLLVM IRにコンパイル
$ llvm-project/build/bin/llvm-dis main.bc -o -  # LLVM IRをテキスト形式に変換</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_llvmをテストする">LLVMをテストする</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>llvm-lit</code> を使用してLLVMをテストできる。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-lit test -s  # 全てのテストを実行する
$ bin/llvm-lit -s --filter 'RV32K' test # RV32Kを含むテストを実行する
$ bin/llvm-lit -as --filter 'RV32K' test # テスト結果を詳細に表示する</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_スケルトンバックエンドを追加する">スケルトンバックエンドを追加する</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#github_riscv-llvm_docs_02">[8]</a>を参考に、中身のないスケルトンのバックエンドをLLVMに追加する。
これによって <code>llc</code> などの出力などにRV32Kが追加される。</p>
</div>
<div class="sect2">
<h3 id="_rv32kをtripleに追加する">RV32KをTripleに追加する</h3>
<div class="paragraph">
<p>参照先<a href="#github_riscv-llvm_patch_0002">[9]</a>のパッチのとおりに書き換える。
基本的に <code>riscv32</code> という文字列を検索し、都度 <code>rv32k</code> の項目を追加していけばよい。
ただし、RISC-Vには32bit（ <code>riscv32</code> ）と64bit（ <code>riscv64</code> ）の変種があるため変換テーブルを用意する必要があるが、
RV32Kにはその必要はない。 <code>UnknownArch</code> を返せば良い。</p>
</div>
<div class="paragraph">
<p>コードを改変した後 <code>$ bin/llvm-lit -s --filter "Triple" test</code> でテストを行う。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32kのelf定義を追加する">RV32KのELF定義を追加する</h3>
<div class="paragraph">
<p><a href="#github_riscv-llvm_patch_03">[13]</a>を参考にファイルを書き換える。
途中 <code>llvm-objdump.cpp</code> の書き換え該当箇所が見当たらない。とりあえず放置（TODO）。</p>
</div>
<div class="paragraph">
<p>出力するELF形式のテストは、出力すべきELFの細部が決まっていないため、
とりあえず書かないでおく（TODO）<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_バックエンドを追加する">バックエンドを追加する</h3>
<div class="paragraph">
<p><a href="#github_riscv-llvm_patch_04">[14]</a>を参考にファイルを修正・追加する。
ただし <code>RV32KTargetMachine::RV32KTargetMachine()</code> の初期化子で使用している
<code>getEffectiveCodeModel()</code> がそのままではコンパイルエラーを出すため修正する<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>。</p>
</div>
<div class="paragraph">
<p>ファイル中のライセンス条項などは、将来的にはApache 2.0 Licenseを明記する予定だが、
とりあえず削除しておく<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>。</p>
</div>
<div class="paragraph">
<p>さて追加したバックエンドも含めてLLVMの再ビルドを行う。
そのためには再び <code>cmake</code> を実行する必要がある：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cmake -G Ninja \
    -DLLVM_ENABLE_PROJECTS=clang \
    -DCMAKE_BUILD_TYPE="Debug" \
    -DBUILD_SHARED_LIBS=True \
    -DLLVM_USE_SPLIT_DWARF=True \
    -DLLVM_OPTIMIZED_TABLEGEN=True \
    -DLLVM_BUILD_TESTS=True \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DLLVM_USE_LINKER=lld \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    -DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD="RISCV;RV32K" \
    ../llvm
$ cmake --build . # OR ninja</pre>
</div>
</div>
<div class="paragraph">
<p>無事 <code>llc --version</code> にRV32Kが含まれるようになった：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llc --version
LLVM (http://llvm.org/):
  LLVM version 8.0.0
  DEBUG build with assertions.
  Default target: x86_64-unknown-linux-gnu
  Host CPU: skylake

  Registered Targets:
    riscv32 - 32-bit RISC-V
    riscv64 - 64-bit RISC-V
    rv32k   - RV32K
    x86     - 32-bit X86: Pentium-Pro and above
    x86-64  - 64-bit X86: EM64T and AMD64</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_簡易的なアセンブラを実装する">簡易的なアセンブラを実装する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>スケルトンバックエンドに実装を追加して、簡易アセンブラを構築する。
わざわざ「簡易」と銘打っているのは、命令を
<code>LI</code>, <code>MV</code>, <code>ADD</code>, <code>SUB</code>, <code>NOP</code> のみに限るためである<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>。
残りの命令については後の章で実装する予定である<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup>。</p>
</div>
<div class="sect2">
<h3 id="_tablegenファイルを追加する">TableGenファイルを追加する</h3>
<div class="paragraph">
<p>LLVMのDSLであるTableGenを使用し、RV32Kのレジスタや命令について記述する。
追加すべきTableGenファイルは次の通り：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RV32KRegisterInfo.td</code>: レジスタ</p>
</li>
<li>
<p><code>RV32KInstrFormats.td</code>: 命令形式</p>
</li>
<li>
<p><code>RV32KInstrInfo.td</code>: 命令</p>
</li>
<li>
<p><code>RV32K.td</code>: 全体</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>RISCV</code> ディレクトリ以下に <code>RISCVInstrFormatsC.td</code> や <code>RISCVInstrInfoC.td</code> などがあるので参考にする。
<code>LWSP</code> はエンコードされると <code>SP</code> の情報を持たないが、表記上は <code>lwsp rd, 100(sp)</code> と書くため <code>SP</code> をとる必要がある。
これのために <code>RegisterClass</code> として <code>SP</code> を定義している。ただし <code>SP</code> には <code>X2</code> のみが所属する。
また、単純に全てのレジスタを <code>GPR</code> として1つの括りにしてしまうと、
<code>sub</code> 命令のオペランドとして <code>x2</code> などが許容されてしまう。
これを防ぐため、 <code>x8</code> から <code>x15</code> を束ねて <code>GPRC</code> という名の <code>RegisterClass</code> を作成し、これを <code>sub</code> 命令のオペランドの型として指定する。</p>
</div>
<div class="paragraph">
<p>即値を単純にとる命令はそのまま記述すればよいが、デコードした値を左シフトするような命令は注意が必要である。
すなわち即値の <code>[7:2]</code> のみを生成コード中に持つような場合は <code>Instruction</code> 中に8bitの即値を宣言し、
その <code>[7:2]</code> 部分が <code>Inst</code> と対応するという形をとる。
なお、この点について <code>RISCVInstrFormatsC.td</code> に書いてある <code>RVInst16CJ</code> の実装が間違っている気がする。
<code>offset</code> は12bitではなかろうか（TODO <a href="#RVInst16CJ-offset">[RVInst16CJ-offset]</a>）。また <code>Bcz</code> も同様の問題があるように見える（TODO）。</p>
</div>
<div class="paragraph">
<p>文字列リテラル中の変数展開をTableGenはサポートしている。すなわち <code>"$rd, ${imm}(${rs})"</code> と書けばレジスタ <code>rd</code> や <code>rs</code>、 即値 <code>imm</code> の中身が展開される。
なおここで変数名を <code>{}</code> で囲む<strong>必要がある</strong>。というのもTableGenでは <code>(</code> や <code>)</code>
もオペランドの名前として認識されてしまうからだ。
実際 <code>$rd, $imm(${rs})</code> と書くと次のようなエラーになる。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>error: unable to find operand: 'imm('</pre>
</div>
</div>
<div class="paragraph">
<p>なおここでの表記はパーズの際に行うパターンマッチのパターンとしての役割と、
アセンブリとして出力を行う際のパターンとしての役割があるようだ（TODO: ほんまか？）。</p>
</div>
<div class="paragraph">
<p>2アドレス方式などで、読み込むレジスタと書き込むレジスタが一致する場合 <code>let Constraints = "$rd = $rd_wb";</code> などと書けばよい。</p>
</div>
<div class="paragraph">
<p>必要なTableGenファイルを追加した後、これらのTableGenファイルが正しいかどうか <code>llvm-tblgen</code> を用いて確認する：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-tblgen -I ../llvm/lib/Target/RV32K/ -I ../llvm/include/ -I ../llvm/lib/Target/ ../llvm/lib/Target/RV32K/RV32K.td</pre>
</div>
</div>
<div class="paragraph">
<p>初めて実行すると、おそらくたくさんエラーがでるので頑張って全て修正する。
変換が成功した場合、生成されたコードが、自分が得たいものになっているかどうかを確認する。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32k用の_mctargetdesc_を追加する">RV32K用の <code>MCTargetDesc</code> を追加する</h3>
<div class="paragraph">
<p>RV32KのELF形式オブジェクトファイルを出力できるようにする。そのために <code>LLVMInitializeRV32KTargetMC()</code> を実装する。
<code>MCTargetDesc</code> サブディレクトリを作成し、その中に <code>RV32KMCTargetDesc.{cpp,h}</code> を作成する。
他のファイルに依存する部分はコメントアウトして、適当な <code>CMakeLists.txt</code> や <code>LLVMBuild.txt</code> を作成・編集すると、
ビルドが通るようになる。そこで次に実装すべき場所を次のように特定する：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-mc -arch=rv32k -filetype=obj foo.s
llvm-mc: /home/anqou/workspace/llvm-project/llvm/tools/llvm-mc/llvm-mc.cpp:355: int main(int, char **): Assertion `MAI &amp;&amp; "Unable to create target asm info!"' failed.
Stack dump:
0.	Program arguments: bin/llvm-mc -arch=rv32k -filetype=obj foo.s
 #0 0x00007ff0c8f93e26 llvm::sys::PrintStackTrace(llvm::raw_ostream&amp;) /home/anqou/workspace/llvm-project/llvm/lib/Support/Unix/Signals.inc:495:11
 #1 0x00007ff0c8f94029 PrintStackTraceSignalHandler(void*) /home/anqou/workspace/llvm-project/llvm/lib/Support/Unix/Signals.inc:559:1
 #2 0x00007ff0c8f91eb3 llvm::sys::RunSignalHandlers() /home/anqou/workspace/llvm-project/llvm/lib/Support/Signals.cpp:68:5
 #3 0x00007ff0c8f947c4 SignalHandler(int) /home/anqou/workspace/llvm-project/llvm/lib/Support/Unix/Signals.inc:0:3
 #4 0x00007ff0c8af73c0 __restore_rt (/usr/lib/libpthread.so.0+0x123c0)
 #5 0x00007ff0c8628d7f __GI_raise (/usr/lib/libc.so.6+0x37d7f)
 #6 0x00007ff0c8613672 __GI_abort (/usr/lib/libc.so.6+0x22672)
 #7 0x00007ff0c8613548 _nl_load_domain.cold.0 (/usr/lib/libc.so.6+0x22548)
 #8 0x00007ff0c8621396 (/usr/lib/libc.so.6+0x30396)
 #9 0x00005588f8384783 main /home/anqou/workspace/llvm-project/llvm/tools/llvm-mc/llvm-mc.cpp:357:3
#10 0x00007ff0c8615223 __libc_start_main (/usr/lib/libc.so.6+0x24223)
#11 0x00005588f838402e _start (bin/llvm-mc+0x2402e)
zsh: abort (core dumped)  bin/llvm-mc -arch=rv32k -filetype=obj foo.s</pre>
</div>
</div>
<div class="paragraph">
<p>この場合 <code>AsmInfo</code> が次に実装すべき場所だと分かる。</p>
</div>
<div class="paragraph">
<p>具体的な編集方法はパッチ<a href="#github_riscv-llvm_patch_06">[15]</a>を参考にする。</p>
</div>
<div class="paragraph">
<p><code>RV32KAsmBackend.cpp</code> の作成時に多くのコンパイルエラーが出た。どうやらこのあたりの仕様変更があったようだ。
具体的には下記のとおりである。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>applyFixup</code> の引数変更。</p>
</li>
<li>
<p><code>mayNeedRelaxation</code> の引数変更。</p>
</li>
<li>
<p><code>writeNopData</code> の引数変更。</p>
</li>
<li>
<p><code>MCAsmBackend::MCAsmBackend</code> の引数変更。</p>
</li>
<li>
<p><code>createObjectWriter</code> の <code>createObjectTargetWriter</code> への名称・引数・戻り値変更。それに伴う <code>createRV32KELFObjectWriter</code> の引数・戻り値変更。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上を実装して動かすとSEGVで落ちる。デバッガで追いかけると、どうやら <code>MCSubtargetInfo</code> の生成関数である <code>createRV32KMCSubtargetInfo</code>
を実装しなければならないようだ。RISC Vの最新のソースコードを参考に実装する。
基本的にはTableGenが生成する <code>createRV32KMCSubtargetInfoImpl</code> をそのまま使えば良いが、これを使用するためには
<code>CMakeLists.txt</code> に <code>tablegen(LLVM RISCVGenSubtargetInfo.inc -gen-subtarget)</code> を追加する必要があるため注意が必要だ。
ちなみにRISC Vのパッチ群では、これらは<a href="#github_riscv-llvm_patch_10">[16]</a>で実装されている。なぜここで実装しなければならなくなったかは、よくわからない。</p>
</div>
<div class="paragraph">
<p>諸々実装すると、次のように出力される：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-mc -arch=rv32k -filetype=obj foo.s
bin/llvm-mc: error: this target does not support assembly parsing.</pre>
</div>
</div>
<div class="paragraph">
<p>なお <code>createRV32KMCCodeEmitter</code> を実装しなくてもこの表示が出るが、それでいいのかはよくわからない。
とりあえずパッチ<a href="#github_riscv-llvm_patch_06">[15]</a>にある分は全て実装する。</p>
</div>
<div class="paragraph">
<p><code>createRV32KMCCodeEmitter</code> を実装する過程で、TableGenがどのように <code>InstrFormats</code> でのフィルード名と
<code>InstrInfo</code> での <code>ins</code> と <code>outs</code> の名前を対応付けるのか調べた。例えば次のように <code>BEQZ</code> 命令をTableGenにて宣言したとする。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class RVInstCB&lt;bits&lt;3&gt; funct3, bits&lt;2&gt; op, dag outs, dag ins, string opcodestr, string argstr&gt;
: RVInst&lt;outs, ins, opcodestr, argstr, []&gt; {
  bits&lt;9&gt; offset;
  bits&lt;3&gt; rs1;

  let Inst{15-13} = funct3;
  let Inst{12} = offset{8};
  let Inst{11-10} = offset{4-3};
  let Inst{9-7} = rs1;
  let Inst{6-5} = offset{7-6};
  let Inst{4-3} = offset{2-1};
  let Inst{2} = offset{5};

  let Opcode = op;
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>def BEQZ : RVInstCB&lt;0b110, 0b01, (outs), (ins GPR:$rs1, simm9_lsb0:$imm),
                    "beqz", "$rs1, $imm"&gt;;</pre>
</div>
</div>
<div class="paragraph">
<p>このときこのTableGenソースコードは期待通りに<strong>動かない</strong>（多分：TODO）。
なぜなら <code>class RVInstCB</code> で指定した <code>offset</code> と <code>rs1</code> が、 <code>def</code> で指定した <code>$rs1</code> と <code>$imm</code> に対応しないからである。
TableGenの実装<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup>や
ドキュメント<a href="#llvm-writing_backend-operand_mapping">[17]</a>によると、これらを対応させる方法には2種類ある：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>両者で同じ名前を採用する。</p>
</li>
<li>
<p>両者で宣言順序を揃える<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>上の例では <code>RVInstCB</code> では <code>offset</code> が先に宣言されているにも関わらず、 <code>BEQZ</code> では <code>$rs1</code> を先に使用した。
この結果 <code>$rs1</code> には <code>offset</code> と <code>rs1</code> の両方が結びつくことになる<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup>。
なおこのような重複が発生してもTableGenは特に警告等を表示しないようだ。よくわからない
<sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup>。</p>
</div>
<div class="paragraph">
<p><code>RV32KMCCodeEmitter::encodeInstruction</code> 内で使用している <code>support::endian::Writer&lt;support::little&gt;(OS).write(Bits);</code> はそのままでは通らない。
RISC Vを参考に <code>support::endian::write&lt;uint16_t&gt;(OS, Bits, support::little);</code> としておく。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32kasmparser_を追加する"><code>RV32KAsmParser</code> を追加する</h3>
<div class="paragraph">
<p>アセンブリをパーズするための <code>RV32KAsmParser</code> を追加する。これによってアセンブリをオブジェクトファイルに直すことができるようになる。
新しく <code>AsmParser</code> ディレクトリを作成し、その中に <code>RV32KAsmParser.cpp</code> 及びそれに付随するファイルを作成する。
例によって、パッチ<a href="#github_riscv-llvm_patch_07">[19]</a>を参考に実装をすすめる。</p>
</div>
<div class="paragraph">
<p><code>RV32KAsmParser.cpp</code> に記述するコード量がそれなりにあるため少々面食らうが、
要するに <code>RV32KAsmParser</code> と <code>RV32KOperand</code> の2つのクラスを作成し、実装を行っている。
パーズの本体は <code>RV32KAsmParser::ParseInstruction</code> である。これを起点に考えれば、それほど複雑な操作はしていない。</p>
</div>
<div class="paragraph">
<p>即値に関して <code>SImm6</code> を <code>SImm12</code> に直す必要がある。これらはTableGenが生成するコードから呼ばれるようだ。</p>
</div>
<div class="paragraph">
<p>ところでRV32Kの命令には <code>add</code> などレジスタを5bitで指定する命令と、
<code>sub</code> などレジスタを3bitで指定する命令の2種類がある。エンコードに際して、これらの区別のための特別な処理は必要ない。
というのも、3bitでレジスタを指定する場合その添字の下位3bit以外が無視されるため、
結果的に正しいコードが出力される<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup>。
例えば <code>x8</code> を指定すると、これに <code>1000</code> という添字が振られ、4bit目を無視することで <code>000</code> となるため、
3bitでのレジスタ指定方法として正しいものになる。</p>
</div>
<div class="paragraph">
<p>そうこうしていると簡易的なアセンブラが完成する：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat foo.s
li x9, 3
mv x11, x1
sub x9, x10
add x8, x1
nop

$ bin/llvm-mc -arch=rv32k -filetype=obj foo.s | od -tx1z -Ax -v
000000 7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00  &gt;.ELF............&lt;
000010 01 00 f5 00 01 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000020 68 00 00 00 00 00 00 00 34 00 00 00 00 00 28 00  &gt;h.......4.....(.&lt;
000030 04 00 01 00 8d 44 86 85 89 8c 06 94 01 00 00 00  &gt;.....D..........&lt;
000040 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000050 00 2e 74 65 78 74 00 2e 73 74 72 74 61 62 00 2e  &gt;..text..strtab..&lt;
000060 73 79 6d 74 61 62 00 00 00 00 00 00 00 00 00 00  &gt;symtab..........&lt;
000070 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000080 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
000090 07 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
0000a0 50 00 00 00 17 00 00 00 00 00 00 00 00 00 00 00  &gt;P...............&lt;
0000b0 01 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00  &gt;................&lt;
0000c0 06 00 00 00 00 00 00 00 34 00 00 00 0a 00 00 00  &gt;........4.......&lt;
0000d0 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00  &gt;................&lt;
0000e0 0f 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00  &gt;................&lt;
0000f0 40 00 00 00 10 00 00 00 01 00 00 00 01 00 00 00  &gt;@...............&lt;
000100 04 00 00 00 10 00 00 00                          &gt;........&lt;
000108</pre>
</div>
</div>
<div class="paragraph">
<p>0x34から0x3dにある <code>8d 44 86 85 89 8c 06 94 01 00</code> が出力であり、
正しく生成されていることが分かる<sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup>。
We made it!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_簡易アセンブラのテストを書く">簡易アセンブラのテストを書く</h2>
<div class="sectionbody">
<div class="paragraph">
<p>適当な入力に対してアセンブラが正しい出力を行うかを確認しつつ
新たなバグの発生を抑止するために、LLVMのフレームワークを用いてテストを書く。</p>
</div>
<div class="sect2">
<h3 id="_rv32kinstprinter_を実装する"><code>RV32KInstPrinter</code> を実装する</h3>
<div class="paragraph">
<p>テストを書くために、まずRV32Kのためのinstruction printerを作成する。
これは内部表現である <code>MCInst</code> から文字列表現であるアセンブリに変換するための機構である。
この後で作成するテストでは、アセンブリを <code>MCInst</code> に変換した上で、
それをアセンブリに逆変換したものがもとのアセンブリと同じであるか否かでテストを行う。</p>
</div>
<div class="paragraph">
<p>まず例によって <code>InstPrinter</code> ディレクトリを作成した後、適切に <code>CMakeLists.txt</code> や
<code>LLVMBuild.txt</code> を作成・編集する。
また <code>RV32KInstPrinter</code> を作成するための関数を <code>LLVMInitializeRV32KTargetMC</code>
にて登録する必要がある。</p>
</div>
<div class="paragraph">
<p>その後 <code>InstPrinter/RV32KInstPrinter.{cpp,h}</code> を作成する。
いつものようにこれはパッチ<a href="#github_riscv-llvm_patch_08">[20]</a>を参考にして行う。</p>
</div>
<div class="paragraph">
<p><code>RV32KInstPrinter::printRegName</code> の実装で用いる <code>getRegisterName</code> の第二引数に
何も渡さなければAltNameを出力に使用する。第二引数に <code>RV32K::NoRegAltName</code> を渡すことで、
レジスタを <code>X0</code>, <code>X1</code>, &#8230;&#8203; と表示することができる。</p>
</div>
<div class="paragraph">
<p>上記をビルドした後、
実際にアセンブリを <code>MCInst</code> に変換し、さらにそれをアセンブリに戻すには、
<code>llvm-mc</code> を用いる：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-mc -arch=rv32k -show-encoding foo.s
	.text
	li	x9, 3                   # encoding: [0x8d,0x44]
	mv	x11, x1                 # encoding: [0x86,0x85]
	sub	x9, x10                 # encoding: [0x89,0x8c]
	add	x8, x1                  # encoding: [0x06,0x94]
	nop	                        # encoding: [0x01,0x00]</pre>
</div>
</div>
<div class="paragraph">
<p><code>-show-encoding</code> を指定することよって当該アセンブリがどのような機械語に
翻訳されるか確認することができる。テストではこの機械語の正誤も確認する。</p>
</div>
</div>
<div class="sect2">
<h3 id="_テストを書く">テストを書く</h3>
<div class="paragraph">
<p>簡易アセンブラが正しく動作していることを保証するためにテストを書く。
ここでは「適当な入力を与えたときに正しく解釈し正しい機械語を生成するか」を確認する。</p>
</div>
<div class="paragraph">
<p>前節と同様にパッチ<a href="#github_riscv-llvm_patch_08">[20]</a>を参考に記述する。
まず <code>test/MC/RISCV</code> ディレクトリを作成する。
その中に <code>rv32k-valid.s</code> と <code>rv32k-invalid.s</code> を作成し、
前者で正しいアセンブリが適切に処理されるか、
後者で誤ったアセンブリに正しくエラーを出力するかを確認する。</p>
</div>
<div class="paragraph">
<p>記述後 <code>llvm-lit</code> を用いてテストを行う：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-lit -as --filter 'RV32K' test
PASS: LLVM :: MC/RV32K/rv32k-valid.s (1 of 2)
Script:
--
: 'RUN: at line 1';   /home/anqou/workspace/llvm-project/build/bin/llvm-mc /data/anqou/workspace/llvm-project/llvm/test/MC/RV32K/rv32k-valid.s -triple=rv32k -show-encoding      | /home/anqou/workspace/llvm-project/build/bin/FileCheck -check-prefixes=CHECK,CHECK-INST /data/anqou/workspace/llvm-project/llvm/test/MC/RV32K/rv32k-valid.s
--
Exit Code: 0


********************
PASS: LLVM :: MC/RV32K/rv32k-invalid.s (2 of 2)
Script:
--
: 'RUN: at line 1';   not /home/anqou/workspace/llvm-project/build/bin/llvm-mc -triple rv32k &lt; /data/anqou/workspace/llvm-project/llvm/test/MC/RV32K/rv32k-invalid.s 2&gt;&amp;1 | /home/anqou/workspace/llvm-project/build/bin/FileCheck /data/anqou/workspace/llvm-project/llvm/test/MC/RV32K/rv32k-invalid.s
--
Exit Code: 0


********************
Testing Time: 0.11s
  Expected Passes    : 2</pre>
</div>
</div>
<div class="paragraph">
<p>テストに通っていることが分かる。YATTA!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_アセンブラに残りの命令を追加する">アセンブラに残りの命令を追加する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>簡易アセンブラに残りの命令を実装する。「簡易」を取り払うということである。
参考にするRISC Vのパッチは<a href="#github_riscv-llvm_patch_09">[22]</a>である。</p>
</div>
<div class="sect2">
<h3 id="_lw_命令を追加する"><code>lw</code> 命令を追加する</h3>
<div class="paragraph">
<p><code>lw</code> 命令は7bit符号なし即値をとる。この即値の下位2ビットは0であることが要求される。
この即値はアセンブリ中でもLLVM内部でも7bitのまま保持される。</p>
</div>
<div class="paragraph">
<p><code>ParserMatchClass</code> は <code>AsmParser</code> がどのようにそのオペランドを読めばよいか指定する。
TableGenで直接指定できない性質は <code>EncoderMethod</code> などを用いてフックし、C\++側から指定する<a href="#llvm_dev_ml-tablegen_definition_question">[23]</a>。</p>
</div>
<div class="paragraph">
<p><code>uimm8_lsb00</code> の <code>let EncoderMethod = "getImmOpValue";</code> は一見不思議に見えるが正常で、
ここでえられた即値は <code>lw</code> の <code>imm</code> になり、そちらで整形される。
<a id="RVInst16CJ-offset"></a>だが <code>simm12_lsb0</code> は <code>getImmOpValueAsr</code> が指定されるので <code>offset</code> は12bitではなく11bitになっている。</p>
</div>
<div class="paragraph">
<p><code>uimm8_lsb00</code> をつくると <code>RV32KOperand::isUImm7Lsb00</code> が無いと言われるので追加する必要がある。
この <code>UImm7Lsb00</code> という名前は <code>ImmAsmOperand</code> の <code>Name</code> に従って作られているようだ。</p>
</div>
<div class="paragraph">
<p><code>generateImmOutOfRangeError</code> の実装に使われているおもしろデータ構造 <code>Twine</code> は
文字列の連結を二分木で持つことで高速に行うことができるらしい<a href="#llvm_doxygen-twine">[24]</a>。</p>
</div>
<div class="paragraph">
<p>メモリ表記のアセンブリをパーズするためには <code>RV32KAsmParser</code> を変更する必要がある。
この処理のエントリポイントは <code>parseOperand</code> で、ここから <code>parseMemOpBaseReg</code> を呼び出す。</p>
</div>
<div class="paragraph">
<p><code>li x11, x12, x13</code> というアセンブリを流し込むと <code>invalid operand for instruction</code> を期待
しているにもかかわらず <code>immediate must be an integer in the range [-32, 31]</code> と出てしまう。
<code>LW</code> を追加する前はそのメッセージが出ていたのでいろいろ調査したが原因不明。
<code>git stash</code> してもとのコードをテストしてみると、実際には</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llvm-mc -arch=rv32k -show-encoding test.s
    .text
test.s:1:14: error: invalid operand for instruction
li x11, x12, x13
             ^</pre>
</div>
</div>
<div class="paragraph">
<p>となっている。すなわちエラーが発生している位置がずれている。もとからおかしかったのだ。
おそらくこれは将来的に解決されるだろうという判断のもと保留（TODO）。</p>
</div>
<div class="paragraph">
<p>テストを忘れずに追加してコミット。</p>
</div>
<div class="paragraph">
<p>ところで <code>getImmOpValue</code> はオペランドにある即値をそのまま返す関数であり、
即値の <code>EncoderMethod</code> にフックとして使用する。
しかしこれは <code>simm6</code> の実装時には不要であり、
実際 <code>let EncoderMethod = "getImmOpValue";</code> をコメントアウトしてもテストには通る。
<a href="#github_riscv-llvm_patch_09">[22]</a>では <code>getImmOpValueAsr1</code> のみが実装されている。
RISC Vの最終的なコードで <code>getImmOpValue</code> は、即値として使えるような複雑な命令を解釈している。</p>
</div>
</div>
<div class="sect2">
<h3 id="_sw_命令を追加"><code>sw</code> 命令を追加</h3>
<div class="paragraph">
<p><code>lw</code> 命令を追加する際に諸々を整えたので、やるだけ。</p>
</div>
</div>
<div class="sect2">
<h3 id="_lwsp_命令を追加"><code>lwsp</code> 命令を追加</h3>
<div class="paragraph">
<p>tdファイルに <code>lwsp</code> を追加してビルドしようとすると次のようなエラーが出た。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>error: Invalid bit range for value
  let Inst{3-2} = imm{7-6};
                     ^</pre>
</div>
</div>
<div class="paragraph">
<p>どうやら <code>imm</code> が6bit即値として扱われているようだ。原因を探すと <code>RVInstCI</code> 内で <code>imm</code> を
6bitと定義していたことが原因だったようだ。RISC V側での実装に合わせ、これを10bitに変更する。
同様に <code>RVInstCI</code> である <code>li</code> の定義も変更し、即値については各々の <code>def</code> で適切に処理するようにした。</p>
</div>
<div class="paragraph">
<p><code>sp</code> を用いたテストを書くと、出力時にこれが <code>x2</code> に変換されてしまうためにエラーになってしまう。
<code>RegisterInfo.td</code> の <code>RegAltNameIndices</code> の定義を変更しAltNameで出力をまかなえるようにした上で、
<code>RV32KInstPrinter::printRegName</code> の実装を改変した。</p>
</div>
</div>
<div class="sect2">
<h3 id="_swsp_命令を追加"><code>swsp</code> 命令を追加</h3>
<div class="paragraph">
<p>tdファイルに <code>swsp</code> を追加するだけ。</p>
</div>
</div>
<div class="sect2">
<h3 id="_j_命令を追加"><code>j</code> 命令を追加</h3>
<div class="paragraph">
<p>RISC Vの仕様上 <code>c.j</code> 命令は12bitの即値フィールドを持つ。
しかしLLVMのRISC Vバックエンド実装では <code>RVInst16CJ</code> は11bitの即値を持つ。
これは末尾1bitが必ず0であるために（ <code>lsb0</code> ）この1bitを捨てることができるためである。
しかしこの実装は <code>lw</code> などがとる即値をそのままのビット数でデータを持つことと一貫性がないように
見受けられる。そこでRV32K実装では <code>j</code> 命令などもすべてそのままのビット数でデータを持つことにする。
したがって <code>simm12_lsb0</code> などに指定する <code>EncoderMethod</code> は <code>getImmOpValueAsr1</code> ではなく
<code>simm6_lsb00</code> と同様の <code>getImmOpValue</code> となる。</p>
</div>
</div>
<div class="sect2">
<h3 id="_jal_jr_jalr_beqz_benz_命令を追加"><code>jal</code> ・ <code>jr</code> ・ <code>jalr</code> ・ <code>beqz</code> ・ <code>benz</code> 命令を追加</h3>
<div class="paragraph">
<p>やるだけ。</p>
</div>
</div>
<div class="sect2">
<h3 id="_属性1を指定する">属性<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>を指定する</h3>
<div class="paragraph">
<p><code>isBranch</code> やら <code>isTerminator</code> やら <code>hasSideEffects</code> やらを命令毎にちゃんと設定する。
これはアセンブラでは意味をなさないが、コンパイラ部分を作り始めると重要になるのだろう。多分（TODO: ほんまか？）。</p>
</div>
<div class="paragraph">
<p>ところでどのような属性フィールドがあるのかはリファレンスを読んでも判然としない。
TableGenのソースコードを読みに行くと <code>llvm/utils/TableGen/CodeGenInstruction.h</code> にて
属性のための大量のフラグが定義されているが、各々がどのような目的で使用されるかは書いていない。
<code>llvm/include/llvm/CodeGen.h</code> に <code>mayLoad</code> や <code>isTerminator</code> ・ <code>isBarrier</code> などの一部分のフラグについて説明がある一方、
<code>hasSideEffects</code> などのフラグについては説明がない。</p>
</div>
<div class="paragraph">
<p><code>hasSideEffects</code> は <code>llvm/lib/Target/RISCV/RISCVInstrInfoC.td</code> の中で <code>C_UNIMP</code> と <code>C_EBREAK</code> でのみ <code>1</code> に設定されている。
特殊な事象が起こらない限り <code>0</code> にしておいて良さそうだ。</p>
</div>
<div class="paragraph">
<p><code>class</code> や <code>def</code> の中に <code>let field = value;</code> と書くのと、外に <code>let field = value in &#8230;&#8203;</code> ないし <code>let field = value in { &#8230;&#8203; }</code>
と書くのは同じ効果を持つが、外に書くと複数の <code>class</code> ・ <code>def</code> にまとめて効果を持つという点においてのみ異なる<a href="#llvm-tablegen-langref">[25]</a>。</p>
</div>
<div class="paragraph">
<p><code>class</code> の段階で <code>hasSideEffects</code> などについて列挙するのは、あまりよいスタイルと思えない。
というのもRV32CなどのISAでは、エンコーディングフォーマットが同じでも全く違う意味をもつ命令を
意味することが往々にしてあるからだ。また我々の開発のように後々ISAを変更することが半ば確定している状況において、
<code>class</code> と複数の <code>def</code> におけるフラグの整合を保ちつつ変更するのは骨が折れる。
それなら <code>class</code> はビットパターンのみを扱うものとし、
<code>def</code> にその意味的な部分（フラグの上げ下げ）を書くほうが、後々の拡張性を考えるとよいと思う<sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_レジスタ指定の_gpr_と_gprc_を使い分ける">レジスタ指定の <code>GPR</code> と <code>GPRC</code> を使い分ける</h3>
<div class="paragraph">
<p><code>RV32KRegisterInfo.td</code> において <code>GPRC</code> は <code>X8</code> から <code>X15</code> までの汎用レジスタを指し、
<code>GPR</code> は <code>X1</code> と <code>X2</code> を含むすべてのレジスタを指すように定義されている。
RV32Kの命令のうち3bit幅でレジスタ番号を指定する命令には <code>GPRC</code> を用い、
5bit幅でレジスタ番号を指定する命令には <code>GPR</code> を用いるようにすることで、
LLVMに適切なレジスタを教えることができる。</p>
</div>
<div class="paragraph">
<p>この別はディスアセンブラを開発する段になって重要になる。というのも、バイナリ中にレジスタ番号として <code>1</code> と出てきた場合、
このオペランドが <code>GPR</code> か <code>GPRC</code> かによって指すレジスタが <code>x1</code> または <code>x9</code> と異なるからである。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ディスアセンブラを実装する">ディスアセンブラを実装する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>アセンブラが一通り実装できたので、今度はディスアセンブラを実装する。
これによって <code>llvm-objdump -d</code> を使用することができるようになる。
このディスアセンブラのテストには、すでに記述した <code>rv32k-valid.s</code> などのテストを使用できる。
すなわちアセンブラによってアセンブリを機械語に直し、さらにディスアセンブラによって機械語をアセンブリに直した結果が、
元のアセンブリと一致するかどうかをみればよい<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup>。</p>
</div>
<div class="paragraph">
<p>参考にするRISC Vのパッチは<a href="#github_riscv-llvm_patch_10">[16]</a>である。</p>
</div>
<div class="sect2">
<h3 id="_rv32kdisassembler_を追加する"><code>RV32KDisassembler</code> を追加する</h3>
<div class="paragraph">
<p><code>*_lsb0</code> や <code>*_lsb00</code> の取り回しがよくわからなくなったので整理<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup>する。
TableGenで指定するビットによって、即値のどの部分をどのように命令コード中に配置するかを決定することができる。
これによって <code>RV32KCodeEmitter::getImmOpValueAsr1</code> などの <code>EncoderMethod</code> に頼る必要がなくなる。
同様にディスアセンブラについても <code>RV32KDisassembler::decodeSImmOperandAndLsl1</code> などの <code>DecoderMethod</code> に
頼る必要がなくなる。言い換えれば、これらのフック関数が受け取る即値は、TableGenで指定したビット単位の
エンコード・デコードをすでに受けた値になる<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup>。
<code>RV32KAsmParser::isUImm12</code> などが呼び出す <code>getConstantImm</code> が返す即値も同様である。</p>
</div>
<div class="paragraph">
<p>ナイーブに実装すると <code>lwsp</code> や <code>swsp</code> が入ったバイナリをディスアセンブルしようとしたときに
エラーがでる。これは例えば次のようにして確認することができる。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat test.s
lwsp x11, 0(sp)

$ bin/llvm-mc -filetype=obj -triple=rv32k &lt; test.s | bin/llvm-objdump -d -</pre>
</div>
</div>
<div class="paragraph">
<p>原因は <code>lwsp</code> や <code>swsp</code> がアセンブリ上はspというオペランドをとるにも関わらず、
バイナリにはその情報が埋め込まれないためである。このためディスアセンブル時に
オペランドが一つ足りない状態になり、配列の添字チェックに引っかかってしまう。</p>
</div>
<div class="paragraph">
<p>これを修正するためには <code>lwsp</code> や <code>swsp</code> に含まれる即値のDecoderが呼ばれたときをフックし、
<code>sp</code> のオペランドが必要ならばこれを補えばよい<sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnotedef_16" title="View footnote.">16</a>]</sup>。
この関数を <code>addImplySP</code> という名前で実装する。ここで即値をオペランドに追加するために呼ぶ
<code>Inst.addOperand</code> と <code>addImplySP</code> の呼び出しの順序に注意が必要である。
すなわち <code>LWSP</code> を <code>RV32KInstrInfo.td</code> で定義したときのオペランドの順序で呼ばなければ
<code>lwsp x11, sp(0)</code> のようなおかしなアセンブリが生成されてしまう。</p>
</div>
<div class="paragraph">
<p>ちなみにエンコード方式にコンフリクトがある場合はビルド時に教えてくれる。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Decoding Conflict:
		111...........01
		111.............
		................
	BNEZ 111___________01
	BNEZhoge 111___________01</pre>
</div>
</div>
<div class="paragraph">
<p>これを防ぐためには、もちろん異なるエンコード方式を指定すればよいのだが、
他にディスアセンブル時に命令を無効化する方法としてTableGenファイルで
<code>isPseudo = 1</code> を指定して疑似命令にしたり
<code>isCodeGen = 1</code> を指定してコード生成時にのみ効力を持つ
命令にすることなどができる。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relocationとfixupに対応する">relocationとfixupに対応する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ワンパスでは決められない値についてあとから補うための機構であるfixupと、
コンパイル時には決定できない値に対してリンカにその処理を任せるためのrelocationについて
対応する。参考にするパッチは<a href="#github_riscv-llvm_patch_11">[27]</a>。</p>
</div>
<div class="paragraph">
<p>必要な作業は大きく分けて次の通り。
* Fixupの種類とその内容を定義する。
* Fixupを適用する関数を定義する。
* アセンブラがFixupを生成するように改変する。
* Fixupが解決されないまま最後まで残る場合は、これをrelocationに変換する。</p>
</div>
<div class="sect2">
<h3 id="_fixupを定義する">Fixupを定義する</h3>
<div class="paragraph">
<p><code>RV32KFixupKinds.h</code> を新規に作成し <code>enum Fixups</code> を定義する。
RV32Kv1では <code>beqz</code> ・ <code>bnez</code> がとる8bitの即値と <code>j</code> ・ <code>jal</code> がとる11bitの即値のために
必要なFixupを定義する。
なお <code>enum</code> の最初のフィールドには <code>FirstTargetFixupKind</code> を設定し、
最後のフィールドは <code>NumTargetFixupKinds</code> として、定義した <code>enum</code> のフィールドの個数を設定する。</p>
</div>
<div class="paragraph">
<p>Fixupの種類からその情報を返すのは <code>RV32KAsmBackend::getFixupKindInfo</code> が行う。
ここでの <code>offset</code> の値は、Fixupのために得られた即値を何ビット左シフトするかを意味し、
<code>bits</code> は TODO を意味している。そこで、即値のフィールドが命令中で2つに分かれている命令のためのFixup
である <code>fixup_rv32k_branch</code> では <code>offset</code> と <code>bits</code> を各々 <code>0</code> と <code>16</code> にしておく
<sup class="footnote">[<a id="_footnoteref_17" class="footnote" href="#_footnotedef_17" title="View footnote.">17</a>]</sup>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixupを適用する関数を定義する">Fixupを適用する関数を定義する</h3>
<div class="paragraph">
<p>要するに <code>RV32KAsmBackend::applyFixup</code> の実装である。補助関数として <code>adjustFixupValue</code> も実装する
<sup class="footnote">[<a id="_footnoteref_18" class="footnote" href="#_footnotedef_18" title="View footnote.">18</a>]</sup></p>
</div>
</div>
<div class="sect2">
<h3 id="_アセンブラにfixupを生成させる">アセンブラにFixupを生成させる</h3>
<div class="paragraph">
<p><code>AsmParser</code> と <code>CodeEmitter</code> を書き換え、必要なときにアセンブラにFixupを生成させるようにする。</p>
</div>
<div class="paragraph">
<p>さてRISC Vでは <code>%hi</code> や <code>%lo</code> などが使えるために、これらを評価するための機構として <code>RISCVMCExpr</code> を導入している。
具体的には <code>RISCVAsmParser::parseImmediate</code> でトークンに <code>AsmToken::Percent</code> が現れた場合に
<code>RISCVAsmParser::parseOperandWithModifier</code> を呼び出し、この中でこれらをパーズして <code>RISCVMCExpr</code> を生成している。</p>
</div>
<div class="paragraph">
<p>しかしRV32Kではこれらの <code>%</code> から始まる特殊な即値<sup class="footnote">[<a id="_footnoteref_19" class="footnote" href="#_footnotedef_19" title="View footnote.">19</a>]</sup>
に対応せず<sup class="footnote">[<a id="_footnoteref_20" class="footnote" href="#_footnotedef_20" title="View footnote.">20</a>]</sup>、あくまで分岐命令の即値におけるラベルのFixupのみが行えれば十分である。
<sup class="footnote">[<a id="_footnoteref_21" class="footnote" href="#_footnotedef_21" title="View footnote.">21</a>]</sup>。</p>
</div>
<div class="paragraph">
<p>そこでまず <code>isSImm9Lsb0</code> などにシンボルが来た場合には <code>true</code> を返すようにする。
これはすなわち、即値を指定するべきところにラベル名が来た場合は <code>true</code> とするということである
<sup class="footnote">[<a id="_footnoteref_22" class="footnote" href="#_footnotedef_22" title="View footnote.">22</a>]</sup>。
その次に <code>getImmOpValue</code> を変更し、即値を書くべき場所にシンボルが来ている場合にはFixupを生成するようにする。
このとき <code>fixup_rv32k_branch</code> と <code>fixup_rv32k_jump</code> のいずれを発行するかは、
オペランドの種類で <code>switch-case</code> して判断している。
これは良くないコーディングスタイルであり、実際<a href="#github_riscv-llvm_docs_06">[28]</a>ではこれを避けるために
種々のInstFormatに手を加えるとはっきり書いてあるのだが、ここでは作業の単純さを重視して
ハードコーディングすることにする。</p>
</div>
<div class="paragraph">
<p>それから <code>RV32KAsmParser::parseImmediate</code> を変更し <code>AsmToken::Identifier</code> が来たときには
<code>MCSymbolRefExpr</code> を生成するようにしておく。この変更は<a href="#github_riscv-llvm_patch_09">[22]</a>に含まれていたものだが、
取り込み忘れていた。</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixupからrelocationへの変換部を実装する">Fixupからrelocationへの変換部を実装する</h3>
<div class="paragraph">
<p><code>RV32KELFObjectWriter::getRelocType</code> を実装すればよいのだが、実のところRV32Kにおけるrelocationはほとんど想定おらず、
仕様も決まっていない。そこでここでは実装を省略する。</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixupのためのテストを書く">Fixupのためのテストを書く</h3>
<div class="paragraph">
<p><code>.space</code> を使って適当に間隔を開けながら命令を並べ、正しく動作しているかを確かめる。</p>
</div>
<div class="paragraph">
<p>これでアセンブラ部分は終了。We made it!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_コンパイラのスケルトンを作成する">コンパイラのスケルトンを作成する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>空の関数とALUオペレーションをサポートできるような最小のバックエンドを作成する。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RV32KAsmPrinter</code> と <code>RV32KMCInstLower</code></p>
<div class="ulist">
<ul>
<li>
<p><code>MachineInstr</code> を <code>MCInst</code> に変換する。</p>
</li>
<li>
<p><code>llvm::LowerRV32KMachineInstrToMCInst</code> で <code>MCInst</code> のオペコード・オペランドを設定する</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>RV32KInstrInfo</code></p>
<div class="ulist">
<ul>
<li>
<p>TableGenによる自動生成。命令を表す <code>enum</code> の定義。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>RV32KRegisterInfo</code></p>
<div class="ulist">
<ul>
<li>
<p>ほとんどTableGenによる自動生成。</p>
</li>
<li>
<p><code>getReservedRegs</code> で変数に割り付ける<strong>べきでない</strong>レジスタを指定する。</p>
</li>
<li>
<p><code>getFrameRegister</code> はframe indicesに用いられるレジスタを指定する（？：TODO）</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>RV32KISelDAGToDAG</code></p>
<div class="ulist">
<ul>
<li>
<p><code>SelectionDAG</code> ノードに対して適切なRV32K命令（多分 <code>MachineInstr</code> ）を見繕う。</p>
</li>
<li>
<p><code>RV32KDAGToDAGISel::Select</code> がエントリポイント</p>
<div class="ulist">
<ul>
<li>
<p>ただしこれはTableGenが生成した <code>SelectCode</code> 関数を呼んでいるだけ。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>RV32KISelLowering</code></p>
<div class="ulist">
<ul>
<li>
<p>LLVM IRを <code>SelectionDAG</code> に変換する。</p>
</li>
<li>
<p>この処理はほとんどターゲット非依存である。</p>
<div class="ulist">
<ul>
<li>
<p>フックを設定して挙動を変化させる。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>RV32KInstrInfo.td</code></p>
<div class="ulist">
<ul>
<li>
<p>ここに「 <code>SelectionDAG</code> をどのようにRV32Kの命令セット（多分 <code>MachineInstr</code> ）に変換するか」が書かれる。</p>
</li>
<li>
<p><code>def : Pat&lt;(hoge), (piyo)&gt;;</code> という表記で「 <code>hoge</code> に <code>SelectionDAG</code> がパターンマッチしたとき <code>piyo</code> に変換する」を意味する。</p>
<div class="ulist">
<ul>
<li>
<p>ここで <code>piyo</code> に記入するのは <code>ins</code> のオペランドのみである。 <code>outs</code> は「戻り値」となる。（TODO；詳細は？）</p>
</li>
</ul>
</div>
</li>
<li>
<p>どのような <code>SelectionDAG</code> にマッチできるかは <code>include/llvm/Target/TargetSelectionDAG.td</code> に情報がある。</p>
</li>
<li>
<p>マッチは命令（ <code>add</code> のような）のみならず「オペランドが即値であるか」などにも適用できる。ただしこの場合その即値の定義が <code>ImmLeaf</code> を継承していることが必要。</p>
</li>
</ul>
</div>
</li>
<li>
<p>関数呼び出し規約やCallee-savedなレジスタについてもここで指定する。</p>
</li>
<li>
<p><code>update_llc_test_checks.py</code> を使用することで、LLVM IRで書かれた関数から生成されるアセンブリのテストを自動的に生成することができる。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>おおよそ次のような過程をたどるようだ<a href="#llvm-code_generator-target_independent_code_gen_alg">[32]</a>。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>LLVM IR
|
| ISelLowering （関数呼び出し規約などSelectionDAGでは扱えない要素を消す）
v
SelectionDAG （仮想的/物理的なレジスタによる表現）
|
| ISelDAGToDAG
v
DAG （MachineInstrのリスト）（命令の順序を決める）
|
|
v
（ここでSSA-basedの最適化・レジスタ割り付け・プロローグエピローグ挿入を行う）
|
| MCInstLower
v
MCInst</pre>
</div>
</div>
<div class="sect2">
<h3 id="_utilsupdatetestchecksasm_py_を変更する"><code>utils/UpdateTestChecks/asm.py</code> を変更する</h3>
<div class="paragraph">
<p><code>update_llc_test_checks.py</code> を使用するために必要な変更らしい。RISCVのための記述を参考にしながら追記すれば良い。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32ktargetlowering_を実装する"><code>RV32KTargetLowering</code> を実装する</h3>
<div class="paragraph">
<p>とりあえずLLVM IRに近いところから実装していくことにする。 <code>RV32KTargetLowering</code> はLLVM IRを <code>SelectionDAG</code> に変換するためのクラスである。
<code>RV32KISelLowering.{h,cpp}</code> で定義される。</p>
</div>
<div class="paragraph">
<p>まずこのクラスのコンストラクタで、ターゲットの仕様を指定する。</p>
</div>
<div class="paragraph">
<p>次いでメンバ関数の <code>LowerFormalArguments</code> で関数呼び出し時の引数の扱いについて記述する。
ここでは引数はすべてレジスタ経由で渡されることにする。
その場合、使用するレジスタクラスを指定して仮想レジスタを作成し、引数に割り付けて追加する。</p>
</div>
<div class="paragraph">
<p>最後に <code>LowerReturn</code> で、関数呼び出しから戻るときの戻り値の扱いについて記述する。
戻り値を解析し、そのすべてをレジスタに詰め込み（複数個あることを前提？）、最後に <code>RET_FLAG</code> を出力している
<sup class="footnote">[<a id="_footnoteref_23" class="footnote" href="#_footnotedef_23" title="View footnote.">23</a>]</sup>。
ここの処理は全体的によくわからない（TODO；特に <code>Chain</code>, <code>Flag</code>, <code>RetOps</code> がどのような働きをしているのか判然としない）。
<code>Chain</code> を通じて <code>SelectionDAG</code> がじゅじゅつなぎになっている？</p>
</div>
<div class="paragraph">
<p>引数が渡ってくるレジスタを <code>CopyFromReg</code> でくるむことで、その（仮想的/物理的）レジスタがこの <code>SelectionDAG</code> の
外側で定義されたものであることを示している。</p>
</div>
<div class="paragraph">
<p>なおRV32Kは下位（sub）に位置づけられるべきターゲットが存在しないが、
それでもターゲットの情報を保持するために <code>RV32KSubTarget</code> を定義することが必要である。
<code>CPUName</code> は <code>RV32K.td</code> や <code>RV32KMCTargetDesc</code> と合わせて <code>generic-rv32k</code> としておく。
Lanaiの実装を見ると <code>generic</code> だけで統一しても良いようだ（TODO）。</p>
</div>
<div class="paragraph">
<p><code>setBooleanContents(ZeroOrOneBooleanContent);</code> はターゲットが1/0でtrue/falseを判定することを設定する。</p>
</div>
<div class="paragraph">
<p>さて上記のように関数呼び出し時の処理を記述するためには、
そもそも関数呼び出し規約の定義を行う必要がある。これは <code>RV32KCallingConv.td</code> にて行う。
関数呼び出し時の引数・戻り値を処理するためのレジスタを指定する。またcallee-savedなレジスタも指定する。</p>
</div>
<div class="paragraph">
<p>ここで戻り値を返すためのレジスタを複数指定することができるようだ。
これはおそらくLLVM IRが複数の戻り値を扱うことができることの単純な反映であろうし（TODO；ほんまか？）、
また例えばRISC VのCalling conventionではa0とa1が戻り値を返すためのレジスタとして指定されているためでも
あると思う。</p>
</div>
<div class="paragraph">
<p>なおここで <code>sp</code> である <code>x2</code> をcallee-savedとして指定する必要はない。
というのもこの処理は関数プロローグ・エピローグで行うことに（将来的に）なるからだ
<sup class="footnote">[<a id="_footnoteref_24" class="footnote" href="#_footnotedef_24" title="View footnote.">24</a>]</sup>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32kdagtodagisel_を実装する"><code>RV32KDAGToDAGISel</code> を実装する</h3>
<div class="paragraph">
<p><code>SelectionDAG</code> をRV32Kコードに変換するためのクラスを実装する。 <code>RV32KISelDAGToDAG.cpp</code> で実装される。
このクラスのエントリポイントは <code>Select</code> であるが、これ自体はTableGenが生成する関数である <code>SelectCode</code> を
呼び出すだけである。そこでこの処理の本体は <code>RV32KInstrInfo.td</code> に記述されることになる。</p>
</div>
<div class="paragraph">
<p>RISCVのCompressedの実装を見ると <code>Pat</code> を継承しない方法で処理をしていた。よくわからない（TODO）。</p>
</div>
<div class="paragraph">
<p>ALU操作のみにとりあえず対応するため、現状対応するのは <code>ADD</code> と <code>SUB</code> 、それから便宜上必要になる
<code>PseudoRET</code> の3つのみである。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32kframelowering_を実装する"><code>RV32KFrameLowering</code> を実装する</h3>
<div class="paragraph">
<p>関数のプロローグとエピローグを出力するためのクラスを実装する。
これらではスタックフレームサイズの調整を行う。
とはいいつつもこれらはまだ実装の必要がないため、ただのプレースホルダになっている。</p>
</div>
<div class="paragraph">
<p>スタックがアドレス負方向に伸びることを <code>TargetFrameLowering</code> のコンストラクタの第一引数に
<code>StackGrowDown</code> を渡すことで表現している。</p>
</div>
</div>
<div class="sect2">
<h3 id="_registerinfo_を実装する"><code>RegisterInfo</code> を実装する</h3>
<div class="paragraph">
<p>まず <code>RV32KRegisterInfo.td</code> を変更し、レジスタを割付優先度順に並び替える。</p>
</div>
<div class="paragraph">
<p>続いて <code>RV32KRegisterInfo</code> クラスを実装する。
<code>getReservedRegs</code> で通常のレジスタ割り付けでは使用しないレジスタを指定する。</p>
</div>
</div>
<div class="sect2">
<h3 id="_rv32kasmprinter_と_rv32kmcinstlower_を実装する"><code>RV32KAsmPrinter</code> と <code>RV32KMCInstLower</code> を実装する</h3>
<div class="paragraph">
<p><a href="#github_riscv-llvm_patch_13">[29]</a>と同様の実装をすればよい。
本体の処理は <code>LowerRV32KMachineInstrToMCInst</code> である。
これは <code>MachineInstr</code> を <code>MCInst</code> に変換している。</p>
</div>
</div>
<div class="sect2">
<h3 id="_その他">その他</h3>
<div class="paragraph">
<p>ビルドに必要なファイルなどを実装する。</p>
</div>
<div class="paragraph">
<p><code>RV32KInstrInfo</code> に <code>let guessInstructionProperties = 0;</code> という文を追加している。
命令の属性（ <code>hasSideEffects</code> など）を推論するためのオプションのようだ（TODO）。</p>
</div>
<div class="paragraph">
<p><code>RV32KGenInstrInfo.inc</code> を読み込むため <code>RV32KInstrInfo.{h,cpp}</code> を追加する。</p>
</div>
<div class="paragraph">
<p><code>RV32KTarget&gt;achine.{h,cpp}</code> を変更する。ここでは <code>RV32KSubtarget</code> のインスタンスを
得るための <code>getSubtargetImpl</code> を実装すると同時に、実行パスに
<code>RV32KDagToDAGISel</code> を挿入するために <code>RV32KPassConfig</code> を実装する
<sup class="footnote">[<a id="_footnoteref_25" class="footnote" href="#_footnotedef_25" title="View footnote.">25</a>]</sup>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_テストを行う">テストを行う</h3>
<div class="paragraph">
<p><code>CodeGen</code> のためのテストを作成する。これはLLVM IRを入力し、出力されるアセンブリが正しいかどうかを判定するものである。</p>
</div>
<div class="paragraph">
<p>テストの枠組みに頼らず、手でテストを行うためには次のようにする。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat test.ll
define i32 @sub(i32 %a, i32 %b) nounwind {
; RV32K-LABEL: sub:
; RV32K:       # %bb.0:
; RV32K-NEXT:    sub x8, x9
; RV32K-NEXT:    jr x1
  %1 = sub i32 %a, %b
  ret i32 %1
}

$ bin/llc -mtriple=rv32k -verify-machineinstrs &lt; test.ll
	.text
	.file	"&lt;stdin&gt;"
	.globl	sub                     # -- Begin function sub
	.p2align	3
	.type	sub,@function
sub:                                    # @sub
# %bb.0:
	sub	x8, x9
	jr	x1
.Lfunc_end0:
	.size	sub, .Lfunc_end0-sub
                                        # -- End function

	.section	".note.GNU-stack","",@progbits</pre>
</div>
</div>
<div class="paragraph">
<p>ついに我々はLLVM IRからコード生成を行うその第一歩を踏み出せたようだ。Here we go!
<sup class="footnote">[<a id="_footnoteref_26" class="footnote" href="#_footnotedef_26" title="View footnote.">26</a>]</sup></p>
</div>
</div>
<div class="sect2">
<h3 id="_selectiondag_とはなにか"><code>SelectionDAG</code> とはなにか</h3>
<div class="paragraph">
<p><a href="#llvm-code_generator-target_independent_code_gen_alg">[32]</a>を参考にまとめる。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SelectionDAG</code> は <code>SDNode</code> をノードとする有向非巡回グラフである。</p>
<div class="ulist">
<ul>
<li>
<p><code>SDNode</code> は大抵opcodeとオペランドを持つ。</p>
</li>
<li>
<p><code>include/llvm/CodeGen/ISDOpcodes.h</code> を見るとどのようなものがあるか分かる。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>SelectionDAG</code> は2つの値を持つ：データフローとコントロールフロー</p>
<div class="ulist">
<ul>
<li>
<p>データフローは単に値がノードになっているだけ。</p>
</li>
<li>
<p>&#8220;chain&#8221; ノードによって副作用を持つ操作（load, store, call, returnなど）の順序が決まる。</p>
<div class="ulist">
<ul>
<li>
<p>副作用を持つ操作はすべてchainを入力として受け取り、新たなchainを出力しなければならない。</p>
<div class="ulist">
<ul>
<li>
<p>伝統的にchainの入力は0番目のオペランドになっており、出力は最後の値になっている。ただしinstruction selectionが起こった後はそうとも限らない。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>&#8220;legal&#8221; なDAGは、そのターゲットがサポートしている操作・型のみで構成されている。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>SelectionDAG</code> を用いたinstruction selectionは <code>SelectionDAG</code> を最適化・正規化することで行われる
<a href="#llvm-code_generator-selectiondag_instruction_selection">[33]</a>。
この過程は <code>-view-dag-combine1-dags</code> などのオプションを <code>llc</code> に与えることでグラフとして見ることができる。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/llc -mtriple=rv32k -view-dag-combine1-dags  &lt; test.ll
# DOTファイルビューワがあればそれが起動する。ない場合は次のようにしてSVGに変換する。
$ dot -Tsvg /tmp/dag.sub-86df29.dot -o dot.svg</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/simple_sub_combine1.svg" alt="simple sub combine1">
</div>
</div>
<div class="paragraph">
<p>それっぽい。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_定数に対応する">定数に対応する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>定数をレジスタに読み込むためのパターンを <code>RV32KInstrInfo.td</code> に追加する。
すなわち <code>simm6</code> が来たら <code>li</code> を呼ぶようにすれば良い。ただしここで <code>li</code> のオペランドには、
渡ってきた即値のみを渡せばよいことに注意が必要である。すなわちレジスタを指定する必要はない。
これは <code>Pat</code> の右側に書くDAGは <code>(ins)</code> のオペランドのみを記載すればよいからである。</p>
</div>
<div class="paragraph">
<p>なお <code>simm6</code> を <code>Pat</code> でも使用できるように <code>ImmLeaf</code> を <code>simm6</code> の継承先に追加する必要がある。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_メモリ操作に対応する">メモリ操作に対応する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ロードとストアのための <code>Pat</code> を追加する。offsetが0の場合と非ゼロの場合で別の <code>def</code> が必要なことに注意。
<code>lw</code> を <code>load</code> に対応付け <code>sw</code> を <code>store</code> に対応付ければ、最低限の実装が整う。
RISC Vではさらに <code>sextloadi8</code> を <code>LB</code> に対応させるなどしているが、
RV32Kv1ではこれらの命令が無い。 <code>lw</code> と他の命令を合わせれば実現できるかもしれないが、
その実装方法がよくわからない。 <code>setOperationAction</code> で <code>Custom</code> 指定とかすればできそうだが詳細不明。(TODO)
<sup class="footnote">[<a id="_footnoteref_27" class="footnote" href="#_footnotedef_27" title="View footnote.">27</a>]</sup></p>
</div>
<div id="implement-copyPhysReg" class="paragraph">
<p>なお参考にするコミット<a href="#github_riscv-llvm_patch_15">[34]</a>のコミットメッセージには <code>copyPhysReg</code> を
実装する必要があると書いてあるが、実際に実装してみるとこれは必要ない。
この関数はどうやらレジスタの中身を移動させる命令を生成するための関数のようで、
使用するレジスタが多くなると使われるようだ。必要になるまで遅延することにする。</p>
</div>
<div class="paragraph">
<p>続くコミット<a href="#github_riscv-llvm_patch_16">[38]</a>はグローバル変数を扱うためのコミットのようだ。
グローバル変数を <code>load</code> する場合、まずその読み込むべきアドレスの値をレジスタに作る必要があるが、
即値ロード命令が限定されているため、即値のアドレスの上位ビットと下位ビットを分けて読み込む必要がある。
そのためにコミットでは <code>%hi</code> と <code>%lo</code> を使用しているが、現状我々のバックエンドにはこれらが実装されていない。
そこで一旦このコミットは飛ばすことにする<sup class="footnote">[<a id="_footnoteref_28" class="footnote" href="#_footnotedef_28" title="View footnote.">28</a>]</sup>。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_条件分岐に対応する">条件分岐に対応する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>条件分岐に<a href="#github_riscv-llvm_patch_17">[39]</a>を参考にして対応する。
ISDには条件分岐として <code>BRCOND</code> と <code>BR_CC</code> の2つがある。
<code>BRCOND</code> は条件分岐のみを行うのに対し、 <code>BR_CC</code> は2ノード間の比較と条件分岐をともに行う。
ここでは、よりパターンマッチが容易な <code>BRCOND</code> にのみ対応することにし、
<code>BR_CC</code> は <code>setOPerationAction</code> を用いて <code>Expand</code> する
<sup class="footnote">[<a id="_footnoteref_29" class="footnote" href="#_footnotedef_29" title="View footnote.">29</a>]</sup>。</p>
</div>
<div class="sect2">
<h3 id="_setlt_と_setgt_に対応する"><code>setlt</code> と <code>setgt</code> に対応する</h3>
<div class="paragraph">
<p>TableGenを用いて <code>brcond</code> に対するパターンマッチを記述する。</p>
</div>
<div class="paragraph">
<p>RV32Kv1では <code>BEQZ</code> と <code>BNEZ</code> のみが定義されている<sup class="footnote">[<a id="_footnoteref_30" class="footnote" href="#_footnotedef_30" title="View footnote.">30</a>]</sup>。
そこで <code>setlt</code> と <code>setgt</code> が自然に定義できる。すなわち <code>$a &lt; $b</code> という比較なら <code>SLT $a, $b</code> 後 <code>BNEZ $a, hoge</code> とする。</p>
</div>
<div class="paragraph">
<p>分岐命令のパターンマッチでは <code>bb</code> というクラスがよく登場する。（ <code>bb:$imm9</code> ）。これはおそらくbasic blockで、
分岐の際に用いるプリミティブな型のようだ。パターンマッチの後半で正しい型を指定することで、実際の型を指定できる気がする。TODO
これと絡む即値の型は <code>Operand&lt;i32&gt;</code> の代わりに <code>Operand&lt;OtherVT&gt;</code> を継承する必要があるようだ。
なおbasic blockを処理するために <code>MachineOperand::MO_MachineBasicBlock</code> についての場合分けを
<code>LowerRV32KMachineOperandToMCOperand</code> に追加する必要がある。</p>
</div>
<div class="paragraph">
<p>LLVM IRをテキスト形式で書く際 <code>brcond</code> という命令は直接は存在せず <code>br</code> 命令を介してこれを使うことになる。
その際 <code>false</code> 部の処理を行うため <code>br</code> 命令も発行されることに注意が必要である。
すなわち <code>brcond</code> のためのパターンマッチのみならず <code>br</code> のためのパターンマッチも潜在的に不可欠である。
これを解決するために</p>
</div>
<div class="literalblock">
<div class="content">
<pre>def : Pat&lt;(br bb:$imm12), (J simm12_lsb0:$imm12)&gt;;</pre>
</div>
</div>
<div class="paragraph">
<p>としても良いように見えるし、実際動く。
しかしRISC Vの実装では <code>PseudoBR</code> を定義して解消しているため、とりあえずこれを採用してみる
<sup class="footnote">[<a id="_footnoteref_31" class="footnote" href="#_footnotedef_31" title="View footnote.">31</a>]</sup>。</p>
</div>
<div class="paragraph">
<p>このPseudo命令を定義するためには <code>RV32KAsmPrinter::lowerOperand</code> を
<a href="#github_riscv-llvm_patch_16">[38]</a>を参考にして実装する必要がある。</p>
</div>
<div class="paragraph">
<p>RV32Kv1の現在の定義では <code>SLT</code> のみが存在するため、ナイーブに定義できるのは <code>setlt</code> のみである。
これを使用するようにSelectionDAGを構成するためには次のようなLLVM IRを入力する。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>define i32 @foo(i32 %a, i32 *%b) {
  %val3 = load volatile i32, i32* %b
  %tst3 = icmp slt i32 %val3, %a
  br i1 %tst3, label %end2, label %end
end:
  ret i32 1
end2:
  ret i32 0
}</pre>
</div>
</div>
<div class="paragraph">
<p>ここで</p>
</div>
<div class="literalblock">
<div class="content">
<pre>  br i1 %tst3, label %end2, label %end</pre>
</div>
</div>
<div class="paragraph">
<p>とすると途中で <code>setge</code> に変換されてしまうため注意が必要である。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/brcond_with_br.svg" alt="brcond with br">
</div>
</div>
<div class="paragraph">
<p>引数を逆転させることで <code>setgt</code> についてもパターンマッチ可能である。</p>
</div>
<div class="paragraph">
<p>なお <code>setlt</code> などを挟まず <code>brcond</code> が単体で現れる場合についてもパターンマッチが可能だが、
これについてLLVM IRでテストを書くと <code>and</code> のSelectionDAGが現れてしまうためRV32Kv1では
コンパイルできない。仕方がないのでテストはなしにしておく。</p>
</div>
</div>
<div class="sect2">
<h3 id="_seteq_と_setne_に対応する"><code>seteq</code> と <code>setne</code> に対応する</h3>
<div class="paragraph">
<p><code>sub</code> と <code>beqz</code> を組み合わせることで <code>seteq</code> を実現可能である。
また <code>sub</code> と <code>bnez</code> を組み合わせることで <code>setne</code> を実現可能である。
しかし <code>sub</code> は左辺を破壊する命令のため、前後の命令との兼ね合いによってはレジスタの値を別のレジスタに移したり、
スタックに保存する必要がある<sup class="footnote">[<a id="_footnoteref_32" class="footnote" href="#_footnotedef_32" title="View footnote.">32</a>]</sup>。そこで<a href="#implement-copyPhysReg">[implement-copyPhysReg]</a>で示唆したように
<a href="#github_riscv-llvm_patch_15">[34]</a>を参考にして <code>RV32KInstrInfo::copyPhysReg</code> を実装し、
さらに<a href="#github_riscv-llvm_patch_17">[39]</a>を参考にして <code>RV32KInstrInfo::storeRegToStackSlot</code> と
<code>RV32KInstrInfo::loadRegFromStackSlot</code> を実装する。
またこれに必要な <code>RV32KRegisterInfo::eliminateFrameIndex</code> も実装する。
この関数は <code>MachineInstr</code> にオペランドとして含まれる <code>FrameIndex</code> を
<code>FrameReg</code> と <code>Offset</code> に変換するための関数である。
<code>storeRegToStackSlot</code> などではオペランドとして <code>FrameIndex</code> を指定し、
即値は <code>0</code> にしておく。そのうえで <code>eliminateFrameIndex</code> を呼び出し、
正しいオペランドに変換している<sup class="footnote">[<a id="_footnoteref_33" class="footnote" href="#_footnotedef_33" title="View footnote.">33</a>]</sup>。
ここでRV32Kv1の <code>lw</code> と <code>sw</code> が符号<strong>なし</strong>即値をとることが問題になる。
すなわち <code>Offset</code> が負数になる場合に対処できない。
この問題はどうすることもできないので、とりあえず放置する。
また <code>FrameReg</code> はRV32Kv1でははっきりと決まっていいないがとりあえず <code>X15</code> にしておく。</p>
</div>
<div class="paragraph">
<p>ここまでで次のようなLLVM IRが</p>
</div>
<div class="literalblock">
<div class="content">
<pre>define void @foo(i32 %a, i32 *%b) {
  %val1 = load volatile i32, i32* %b
  %tst1 = icmp slt i32 %val1, %a
  br i1 %tst1, label %end, label %test2

test2:
  %val2 = load volatile i32, i32* %b
  %tst2 = icmp sgt i32 %val2, %a
  br i1 %tst2, label %end, label %test3

test3:
  %val3 = load volatile i32, i32* %b
  %tst3 = icmp eq i32 %val3, %a
  br i1 %tst3, label %end, label %test4

test4:
  %val4 = load volatile i32, i32* %b
  %tst4 = icmp ne i32 %val4, %a
  br i1 %tst4, label %end, label %test5

test5:
  %val5 = load volatile i32, i32* %b
  br label %end

end:
  ret void
}</pre>
</div>
</div>
<div class="paragraph">
<p>次のようなRV32Kv1コードに変換される。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>	.globl	foo                     # -- Begin function foo
	.p2align	3
	.type	foo,@function
foo:                                    # @foo
# %bb.0:
	lw	x10, 0(x9)
	slt	x10, x8
	bnez	x10, .LBB0_5
	j	.LBB0_1
.LBB0_1:                                # %test2
	lw	x10, 0(x9)
	mv	x11, x8
	slt	x11, x10
	bnez	x11, .LBB0_5
	j	.LBB0_2
.LBB0_2:                                # %test3
	lw	x10, 0(x9)
	sub	x10, x8
	beqz	x10, .LBB0_5
	j	.LBB0_3
.LBB0_3:                                # %test4
	lw	x10, 0(x9)
	sub	x10, x8
	bnez	x10, .LBB0_5
	j	.LBB0_4
.LBB0_4:                                # %test5
	lw	x8, 0(x9)
.LBB0_5:                                # %end
	jr	x1
.Lfunc_end0:
	.size	foo, .Lfunc_end0-foo
                                        # -- End function

	.section	".note.GNU-stack","",@progbits</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_関数呼び出しに対応する">関数呼び出しに対応する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>関数呼び出しをサポートするためにはi) <code>PseudoCALL</code> を実装しii) <code>RV32KTargetLowering::LowerCall</code>
を実装すれば良いようだ。前者は <code>JAL</code> に展開され、
後者はLLVM IRから <code>SelectionDAG</code> への変換を担う。</p>
</div>
<div class="paragraph">
<p>LLVM IRの <code>call</code> は、まず <code>lui</code> と <code>addi</code> で関数のアドレスを取得した後、
<code>jalr</code> でその場所で飛ぶようなアセンブリに変換される。ただLLVM 9の <code>clang</code> でアセンブリを出力
させると <code>call</code> 命令を使うものが出力される。RISC Vのソースコードを見ると次のようにある。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// PseudoCALL is a pseudo instruction which will eventually expand to auipc
// and jalr while encoding. This is desirable, as an auipc+jalr pair with
// R_RISCV_CALL and R_RISCV_RELAX relocations can be be relaxed by the linker
// if the offset fits in a signed 21-bit immediate.
// Define AsmString to print "call" when compile with -S flag.
// Define isCodeGenOnly = 0 to support parsing assembly "call" instruction.</pre>
</div>
</div>
<div class="paragraph">
<p>アセンブリ出力時のみ <code>call</code> を使うようだ。</p>
</div>
<div class="paragraph">
<p>関数のアドレスはグローバルなので、そのアドレスを取得するコードを <code>lowerCall</code> 中に
記述する必要がある。パッチ<a href="#github_riscv-llvm_patch_18">[42]</a>では <code>lowerGlobalAddress</code> を読んでいるが、
これは実装していない。そこでこの処理を応急処置的に書くことにする。
現状のRV32Kv1ではすべての関数呼び出しのアドレスはFxiupで解決される（relocationに回らない）
と前提しているので、そのとおりに実装する。</p>
</div>
<div class="paragraph">
<p><code>LowerCall</code> ではおおよそi) 引数を解析してii) <code>CALLSEQ_START</code> ノードを出力しiii)
引数を処理するためのDAG（ <code>CopyToReg</code> ）をはさみiii) <code>CALL</code> ノードを出力しiv)
<code>CALLSEQ_END</code> ノードを出力し v) 返ってきた値を <code>CopyFromReg</code> ノードを出力することで
取り出している、ようだ。他にも様々な処理が挟まっているが、よくわからない。TODO</p>
</div>
<div class="paragraph">
<p><code>CopyFromReg</code> は物理レジスタ（physical register）<strong>から</strong>仮想レジスタ（virtual register）に
値をコピーするようなDAGを生成し、逆に <code>CopyToReg</code> は物理レジスタ<strong>へ</strong>仮想レジスタの中の
値をコピーするようなDAGを生成する。一般のレジスタ割り付けが行われる以前であっても、
例えば関数の引数・戻り値のように割り付けるべき物理レジスタが決まる場合がある。
この区別をこのDAGは行っているようだ。
したがって <code>LowerCall</code> では <code>CopyToReg</code> を使って引数を詰め込み、
関数を呼び、それが終わったら <code>CopyFromReg</code> を使って戻り値を取り出しているということになる。</p>
</div>
<div class="paragraph">
<p>さて <code>PseudoCALL</code> はパッチ<a href="#github_riscv-llvm_patch_18">[42]</a>では <code>jalr</code> に展開される。
一見 <code>jal</code> に展開すれば良いように思えるし、実際RISC Vの実装ではそうなっているのだが、
そうするためには <code>PseudoCALL</code> の <code>ins</code> に指定するクラスを作成する必要がある。
RISC Vでは <code>bare_symbol</code> が、Lanaiでは <code>CallTarget</code> がそれに当たる。
複雑で良くわからないのでとりあえずここは <code>jalr</code> に展開することにする。</p>
</div>
<div class="paragraph">
<p><code>let Defs = [X1]</code> を <code>PseudoCALL</code> にかぶせているのは、おそらく <code>X1</code> が <code>jalr</code> によって
書き換えられることを意味している。 <code>jalr</code> が <code>X1</code> を <code>outs</code> に含めていないのは、
おそらく <code>jalr</code> が <code>X1</code> を出力するというわけではないからだと思うがわからない。TODO</p>
</div>
<div class="paragraph">
<p><code>getCallPreservedMask</code> を定義する必要がある。Callee-savedなレジスタに関する情報を
渡すための関数のようだ。（おそらく；TODO）TableGenが再生する <code>CSR_RegMask</code> をそのまま返せば良い。</p>
</div>
<div class="paragraph">
<p><code>CallSeqStart</code> と <code>CallSeqEnd</code> は <code>ADJCALLSTACKDOWN</code> ・ <code>ADJCALLSTACKUP</code> に結びつける必要がある。
これらが <code>let Defs = [X2], Uses = [X2]</code> で囲まれているのは（おそらく） <code>X2</code> を書き換えつつ、
かつその（過去の？；TODO）値を使用するから。</p>
</div>
<div class="paragraph">
<p>すると次のようなエラーが出る。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Can't store this register to stack slot
UNREACHABLE executed at /home/anqou/ano/secure_vm/llvm-project/llvm/lib/Target/RV32K/RV32KInstrInfo.cpp:55!</pre>
</div>
</div>
<div class="paragraph">
<p>そこで <code>ADJCALLSTACKDOWN</code> らを <code>RV32KGenInstrInfo</code> のコンストラクタに渡すようにすると、
また次のようなエラーが出る。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Call Frame Pseudo Instructions do not exist on this target!
UNREACHABLE executed at /home/anqou/ano/secure_vm/llvm-project/llvm/include/llvm/CodeGen/TargetFrameLowering.h:299!</pre>
</div>
</div>
<div class="paragraph">
<p>そこで <code>eliminateCallFramePseudoInstr</code> を実装する。
この関数は関数呼び出しのための疑似命令を具体的な命令に置き換えるための関数のようだが、
ここではその疑似命令を削除するに留める。</p>
</div>
<div class="paragraph">
<p>するとまた初めのエラーが再燃した。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Can't store this register to stack slot
UNREACHABLE executed at /home/anqou/ano/secure_vm/llvm-project/llvm/lib/Target/RV32K/RV32KInstrInfo.cpp:56!</pre>
</div>
</div>
<div class="paragraph">
<p>よくよく見てみると、当該ソースコードは次のようになっている。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>void RV32KInstrInfo::storeRegToStackSlot(MachineBasicBlock &amp;MBB,
                                         MachineBasicBlock::iterator I,
                                         unsigned SrcReg, bool IsKill, int FI,
                                         const TargetRegisterClass *RC,
                                         const TargetRegisterInfo *TRI) const {
  DebugLoc DL;
  if (I != MBB.end())
    DL = I-&gt;getDebugLoc();

  if (RV32K::GPRCRegClass.hasSubClassEq(RC))
    BuildMI(MBB, I, DL, get(RV32K::SW))
        .addReg(SrcReg, getKillRegState(IsKill))
        .addFrameIndex(FI)
        .addImm(0);
  else
    llvm_unreachable("Can't store this register to stack slot");
}</pre>
</div>
</div>
<div class="paragraph">
<p>レジスタをスタックに対比するMIを生成するためのコードである。
ここで <code>sw</code> 命令が <code>GPRC</code> レジスタのみをとることが災いし <code>x1</code> をスタックに積むことができない。
したがって<strong>RV32Kv1の枠組みでは関数呼び出しを行えないことが判明した</strong>。</p>
</div>
<div class="paragraph">
<p>RV32Kv1のためのLLVMバックエンド作成はここで（突然）中止である<sup class="footnote">[<a id="_footnoteref_34" class="footnote" href="#_footnotedef_34" title="View footnote.">34</a>]</sup>
<sup class="footnote">[<a id="_footnoteref_35" class="footnote" href="#_footnotedef_35" title="View footnote.">35</a>]</sup>。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参照">参照</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="github_riscv-llvm_docs_01"></a>[1] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/docs/01-intro-and-building-llvm.mkd" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/docs/01-intro-and-building-llvm.mkd</a></p>
</li>
<li>
<p><a id="llvm_getting-started"></a>[2] <a href="https://llvm.org/docs/GettingStarted.html" class="bare">https://llvm.org/docs/GettingStarted.html</a></p>
</li>
<li>
<p><a id="clang_gettings-started"></a>[3] <a href="https://clang.llvm.org/get_started.html" class="bare">https://clang.llvm.org/get_started.html</a></p>
</li>
<li>
<p><a id="asciidoctor_user-manual"></a>[4] <a href="https://asciidoctor.org/docs/user-manual/" class="bare">https://asciidoctor.org/docs/user-manual/</a></p>
</li>
<li>
<p><a id="riscv"></a>[5] <a href="https://riscv.org/" class="bare">https://riscv.org/</a></p>
</li>
<li>
<p><a id="riscv_specifications"></a>[6] <a href="https://riscv.org/specifications/" class="bare">https://riscv.org/specifications/</a></p>
</li>
<li>
<p><a id="fox-llvm"></a>[7] 『きつねさんでもわかるLLVM〜コンパイラを自作するためのガイドブック〜』（柏木 餅子・風薬・矢上 栄一、株式会社インプレス、2013年）</p>
</li>
<li>
<p><a id="github_riscv-llvm_docs_02"></a>[8] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/docs/02-starting-the-backend.mkd" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/docs/02-starting-the-backend.mkd</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_0002"></a>[9] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0002-RISCV-Recognise-riscv32-and-riscv64-in-triple-parsin.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0002-RISCV-Recognise-riscv32-and-riscv64-in-triple-parsin.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm"></a>[10] <a href="https://github.com/lowRISC/riscv-llvm" class="bare">https://github.com/lowRISC/riscv-llvm</a></p>
</li>
<li>
<p><a id="youtube_llvm-backend-development-by-example"></a>[11] <a href="https://www.youtube.com/watch?v=AFaIP-dF-RA" class="bare">https://www.youtube.com/watch?v=AFaIP-dF-RA</a></p>
</li>
<li>
<p><a id="msyksphinz_try-riscv64-llvm-backend"></a>[12] <a href="http://msyksphinz.hatenablog.com/entry/2019/01/02/040000_1" class="bare">http://msyksphinz.hatenablog.com/entry/2019/01/02/040000_1</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_03"></a>[13] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0003-RISCV-Add-RISC-V-ELF-defines.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0003-RISCV-Add-RISC-V-ELF-defines.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_04"></a>[14] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0004-RISCV-Add-stub-backend.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0004-RISCV-Add-stub-backend.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_06"></a>[15] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0006-RISCV-Add-bare-bones-RISC-V-MCTargetDesc.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0006-RISCV-Add-bare-bones-RISC-V-MCTargetDesc.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_10"></a>[16] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0010-RISCV-Add-support-for-disassembly.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0010-RISCV-Add-support-for-disassembly.patch</a></p>
</li>
<li>
<p><a id="llvm-writing_backend-operand_mapping"></a>[17] <a href="https://llvm.org/docs/WritingAnLLVMBackend.html#instruction-operand-mapping" class="bare">https://llvm.org/docs/WritingAnLLVMBackend.html#instruction-operand-mapping</a></p>
</li>
<li>
<p><a id="llvm-writing_backend"></a>[18] <a href="https://llvm.org/docs/WritingAnLLVMBackend.html" class="bare">https://llvm.org/docs/WritingAnLLVMBackend.html</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_07"></a>[19] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0007-RISCV-Add-basic-RISCVAsmParser.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0007-RISCV-Add-basic-RISCVAsmParser.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_08"></a>[20] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0008-RISCV-Add-RISCVInstPrinter-and-basic-MC-assembler-te.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0008-RISCV-Add-RISCVInstPrinter-and-basic-MC-assembler-te.patch</a></p>
</li>
<li>
<p><a id="llvm-tablegen"></a>[21] <a href="https://llvm.org/docs/TableGen/index.html" class="bare">https://llvm.org/docs/TableGen/index.html</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_09"></a>[22] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0009-RISCV-Add-support-for-all-RV32I-instructions.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0009-RISCV-Add-support-for-all-RV32I-instructions.patch</a></p>
</li>
<li>
<p><a id="llvm_dev_ml-tablegen_definition_question"></a>[23] <a href="http://lists.llvm.org/pipermail/llvm-dev/2015-December/093310.html" class="bare">http://lists.llvm.org/pipermail/llvm-dev/2015-December/093310.html</a></p>
</li>
<li>
<p><a id="llvm_doxygen-twine"></a>[24] <a href="https://llvm.org/doxygen/classllvm_1_1Twine.html" class="bare">https://llvm.org/doxygen/classllvm_1_1Twine.html</a></p>
</li>
<li>
<p><a id="llvm-tablegen-langref"></a>[25] <a href="https://llvm.org/docs/TableGen/LangRef.html" class="bare">https://llvm.org/docs/TableGen/LangRef.html</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_docs_05"></a>[26] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/docs/05-disassembly.mkd" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/docs/05-disassembly.mkd</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_11"></a>[27] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0011-RISCV-Add-common-fixups-and-relocations.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0011-RISCV-Add-common-fixups-and-relocations.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_docs_06"></a>[28] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/docs/06-relocations-and-fixups.mkd" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/docs/06-relocations-and-fixups.mkd</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_13"></a>[29] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0013-RISCV-Initial-codegen-support-for-ALU-operations.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0013-RISCV-Initial-codegen-support-for-ALU-operations.patch</a></p>
</li>
<li>
<p><a id="speakerdeck-llvm_backend_development"></a>[30] <a href="https://speakerdeck.com/asb/llvm-backend-development-by-example-risc-v" class="bare">https://speakerdeck.com/asb/llvm-backend-development-by-example-risc-v</a></p>
</li>
<li>
<p><a id="llvm-code_generator"></a>[31] <a href="https://llvm.org/docs/CodeGenerator.html" class="bare">https://llvm.org/docs/CodeGenerator.html</a></p>
</li>
<li>
<p><a id="llvm-code_generator-target_independent_code_gen_alg"></a>[32] <a href="https://llvm.org/docs/CodeGenerator.html#target-independent-code-generation-algorithms" class="bare">https://llvm.org/docs/CodeGenerator.html#target-independent-code-generation-algorithms</a></p>
</li>
<li>
<p><a id="llvm-code_generator-selectiondag_instruction_selection"></a>[33] <a href="https://llvm.org/docs/CodeGenerator.html#selectiondag-instruction-selection-process" class="bare">https://llvm.org/docs/CodeGenerator.html#selectiondag-instruction-selection-process</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_15"></a>[34] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0015-RISCV-Codegen-support-for-memory-operations.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0015-RISCV-Codegen-support-for-memory-operations.patch</a></p>
</li>
<li>
<p><a id="cpu0"></a>[35] <a href="https://jonathan2251.github.io/lbd/" class="bare">https://jonathan2251.github.io/lbd/</a></p>
</li>
<li>
<p><a id="elvm-llvm_backend"></a>[36] <a href="https://github.com/shinh/llvm/tree/elvm" class="bare">https://github.com/shinh/llvm/tree/elvm</a></p>
</li>
<li>
<p><a id="elvm-slide"></a>[37] <a href="http://shinh.skr.jp/slide/llel/000.html" class="bare">http://shinh.skr.jp/slide/llel/000.html</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_16"></a>[38] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0016-RISCV-Codegen-support-for-memory-operations-on-globa.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0016-RISCV-Codegen-support-for-memory-operations-on-globa.patch</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_17"></a>[39] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0017-RISCV-Codegen-for-conditional-branches.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0017-RISCV-Codegen-for-conditional-branches.patch</a></p>
</li>
<li>
<p><a id="todai_llvm_backend"></a>[40] <a href="https://github.com/cpu-experiment-2018-2/llvm/tree/master/lib/Target/ELMO" class="bare">https://github.com/cpu-experiment-2018-2/llvm/tree/master/lib/Target/ELMO</a></p>
</li>
<li>
<p><a id="todai_llvm_backend-article"></a>[41] <a href="http://uenoku.hatenablog.com/entry/2018/12/25/044244" class="bare">http://uenoku.hatenablog.com/entry/2018/12/25/044244</a></p>
</li>
<li>
<p><a id="github_riscv-llvm_patch_18"></a>[42] <a href="https://github.com/lowRISC/riscv-llvm/blob/master/0018-RISCV-Support-for-function-calls.patch" class="bare">https://github.com/lowRISC/riscv-llvm/blob/master/0018-RISCV-Support-for-function-calls.patch</a></p>
</li>
<li>
<p><a id="llvm-langref"></a>[43] <a href="http://llvm.org/docs/LangRef.html" class="bare">http://llvm.org/docs/LangRef.html</a></p>
</li>
<li>
<p><a id="fpga_develop_diary"></a>[44] <a href="http://msyksphinz.hatenablog.com/" class="bare">http://msyksphinz.hatenablog.com/</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. これを属性と呼んでいいかどうかよくわからないが、わかりやすいし呼びやすいのでとりあえずこれで。内部的にはrecordと書かれることが多いようだ。
</div>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. この変更は後で行ったため、後ろの記述に齟齬が発生する場合がある（TODO）。
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. 同ファイル内にある同名のstatic関数を関数呼び出しの候補に入れていないようだ。原因不明。v8.0.0にて採用されているRISC-Vのコードを参考に、別の場所で定義されている同名関数を利用するよう修正した。
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. LLVMのARMバックエンドはApache 2.0 Licenseに例外条項を 付与したライセンスになっていた。検討の余地あり。
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. この方針はアセンブラを書き始めてから決めたため、以下の記述に不整合が生じている場合がある。いずれ修正する（TODO）。
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. 蓋し <code>RV32KInstrInfo.td</code> を書くのは見た目によらず難しい。ある程度進んでから戻ってくるほうが良いだろう。
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. <code>utils/TableGen/CodeEmitterGen.cpp</code> などを参照。
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. 関係するすべての <code>class</code> での宣言が対象になるようだが、それらがどの順に対応するのかは判然としない。
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. 名前での対応により <code>rs1</code> が結びつき、順序による対応で <code>offset</code> が結びつく。
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. アセンブルではエラーが出ないが、ディスアセンブルで「オペランドが無い」というエラーが（添字チェックに引っかかるという形で）出る場合がある。
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. LLVMのRISC V実装でもこの方式が採用されている。
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. 白状すると、確認していない。次のステップでテストを書くため、そこで確認する。
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. ただしこれは命令数が少ない場合に限るのかもしれない。
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. <a href="#github_riscv-llvm_docs_05">[26]</a>にはfull round trip testingと表現されている。
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. 整理というより半分推測だが。
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. バイナリに直接触れるのはTableGenが出力するコードなので、当然といえば当然だが。
</div>
<div class="footnote" id="_footnotedef_16">
<a href="#_footnoteref_16">16</a>. この実装手法はRISC Vのそれによる。かなりad-hocだと感じるが、他の方法が分からないのでとりあえず真似る。
</div>
<div class="footnote" id="_footnotedef_17">
<a href="#_footnoteref_17">17</a>. これはRISC Vの実装を真似ている。
</div>
<div class="footnote" id="_footnotedef_18">
<a href="#_footnoteref_18">18</a>. ところでRISC Vの <code>fixup_riscv_rvc_{jump,branch}</code> の実装では即値の幅のチェックを行っていない。 なぜかはよくわからない。あと <code>fixup_riscv_jal</code> のコメントが間違っている気がする。
</div>
<div class="footnote" id="_footnotedef_19">
<a href="#_footnoteref_19">19</a>. 内部的にはoperand with modifiersと呼ばれているようだ。
</div>
<div class="footnote" id="_footnotedef_20">
<a href="#_footnoteref_20">20</a>. とりあえずはね。
</div>
<div class="footnote" id="_footnotedef_21">
<a href="#_footnoteref_21">21</a>. なおRISC Vの <code>classifySymbolRef</code> を見るとシンボルの引き算ができるように見えるが、実際に試してみると <code>getImmOpValue</code> で <code>Unhandled expression</code> が出て落ちてしまった。よくわからない。即値としては認識される（ <code>isSImm12</code> などが <code>true</code> を返す）が、 Fixupとして受領されない（ <code>getImmOpValue</code> でエラーになる）気がする。TODO
</div>
<div class="footnote" id="_footnotedef_22">
<a href="#_footnoteref_22">22</a>. ここで <code>isImm</code> を呼び出す必要があることに注意が必要である。「即値」と聞くと整数値のみを受け取ると誤解しがちだが、 実際には <code>RV32KOperand</code> の <code>ImmOp</code> は <code>MCExpr</code> をその値として持っている。したがって、シンボルなどを含めた 即値を求めるための演算そのものが対象になっている。すなわち <code>isImm</code> が <code>true</code> であることを確認することで、 ラベル名が来るべきところにレジスタ名などが来ないことを担保しているのである。 またより形式的には、これは <code>RV32KOperand</code> が持つ共用体の中身が <code>ImmOp</code> となっていることを保証している。
</div>
<div class="footnote" id="_footnotedef_23">
<a href="#_footnoteref_23">23</a>. ここでの <code>RET_FLAG</code> は <code>RV32KDAGToDAGISel</code> にて <code>JR X1</code> に変換される疑似命令である。 <a href="#fox-llvm">[7]</a>では直接 <code>jr</code> 命令を参照していたが、それよりも「関数からのリターンである」 という意味的情報を付加できるというメリットがありそうだ（TODO；ほんまか？）
</div>
<div class="footnote" id="_footnotedef_24">
<a href="#_footnoteref_24">24</a>. <a href="#github_riscv-llvm_patch_13">[29]</a>のコミットメッセージを参考のこと。
</div>
<div class="footnote" id="_footnotedef_25">
<a href="#_footnoteref_25">25</a>. 他の変換は <code>RV32KSubtarget</code> 経由で呼び出される。この変換のみが異なるようだ。
</div>
<div class="footnote" id="_footnotedef_26">
<a href="#_footnoteref_26">26</a>. 言い換えればここからが本番ということで、ここまでは長い長い前座だったのだ。 それでも一つ終わったことは良いことだ。祝杯にコーヒーを入れよう。
</div>
<div class="footnote" id="_footnotedef_27">
<a href="#_footnoteref_27">27</a>. その後RV32Kv2以降でHW側で実装と合意。
</div>
<div class="footnote" id="_footnotedef_28">
<a href="#_footnoteref_28">28</a>. そもそもRV32Kv1の枠組みでは32bit即値を読み込むことが 困難であるという事情もある。
</div>
<div class="footnote" id="_footnotedef_29">
<a href="#_footnoteref_29">29</a>. おそらく <code>BRCOND</code> に書き換えるということ。どう書き換えるかがどこで定義されているかはよくわからない。TODO
</div>
<div class="footnote" id="_footnotedef_30">
<a href="#_footnoteref_30">30</a>. RV32Cではこれらは <code>BEQ</code> ・ <code>BNE</code> 命令から置換する形で使用される。
</div>
<div class="footnote" id="_footnotedef_31">
<a href="#_footnoteref_31">31</a>. 要するにちゃんとした理由がないのだが、そのうち同様の実装を必要とする Pseudo命令が出てくるだろうという予測はある。
</div>
<div class="footnote" id="_footnotedef_32">
<a href="#_footnoteref_32">32</a>. 実はこの時点ではこの需要は微妙なところだが、まあそのうち必要になることに疑いはない。
</div>
<div class="footnote" id="_footnotedef_33">
<a href="#_footnoteref_33">33</a>. と思う。裏はあんまり取っていない。TODO
</div>
<div class="footnote" id="_footnotedef_34">
<a href="#_footnoteref_34">34</a>. 作りながら、このISAでは 限界がありそうだと感じていたが、しかしLLVMがハングするまでここで中止になることはわからなかった。
</div>
<div class="footnote" id="_footnotedef_35">
<a href="#_footnoteref_35">35</a>. あとから気づいたが、直接スタックに積むのではなく一旦 <code>GPRC</code> のレジスタに <code>mv</code> してから スタックに積めばこの問題を回避できたのかもしれない。ただここで「どのレジスタに一旦退避するか」を どう求めればよいかは良くわからない。
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-05-03 12:31:59 UTC
</div>
</div>
</body>
</html>